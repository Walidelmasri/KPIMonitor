@model IEnumerable<KPIMonitor.Models.KpiFiveYearTarget>
@{
    ViewData["Title"] = "Five-Year Targets";
    var kpis = ViewBag.Kpis as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
}

@if (TempData["Msg"] is string msg)
{
    <div class="alert alert-success rounded-4 mx-3 mt-3">@msg</div>
}

<div class="container py-5">
    @section PageHeader {
        <div class="page-hero" style="background-image:url('@Url.Content("~/images/pic1.jpg")')">
            <div class="page-hero-content">
                <h1 class="page-title">ðŸ“… KPI Five-Year Targets</h1>
            </div>
        </div>
    }

    <!-- FIXED: proper rails wrapper + proper row -->
    <div class="with-rails">
        <div class="row justify-content-center">
            <div class="col-12">

<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <!-- Filters -->
    <form method="get" class="d-flex align-items-center gap-2 mb-0 flex-nowrap">
        <!-- Pillar -->
        @Html.DropDownList(
            "pillarId",
            (SelectList)ViewBag.Pillars,
            "All pillars",
            new {
                @class = "form-select",
                style = "min-width:260px",
                onchange = "this.form.submit()" // auto-submit pillar change
            }
        )

        <!-- Objective -->
        @Html.DropDownList(
            "objectiveId",
            (SelectList)ViewBag.Objectives,
            "All objectives",
            new {
                @class = "form-select",
                style = "min-width:260px",
                onchange = "this.form.submit()" // auto-submit objective change
            }
        )

        <!-- Reset -->
        @if (ViewBag.CurrentPillarId != null || ViewBag.CurrentObjectiveId != null)
        {
            <a class="btn btn-outline-secondary" href="@Url.Action("Index")">Reset</a>
        }
    </form>

    <!-- Add button -->
    <a class="btn btn-add" href="@Url.Action("Create")">âž• Add Five-Year Target</a>
</div>

                <div class="table-responsive shadow-sm rounded-4 border bg-white">
                    <table class="table table-striped table-bordered mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="min-width:260px;">KPI</th>
                                <th style="width:110px;">Base</th>
                                <th>Period 1</th>
                                <th>Period 2</th>
                                <th>Period 3</th>
                                <th>Period 4</th>
                                <th>Period 5</th>
                                <th style="width:170px;">Audit</th>
                                <th style="width:110px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                foreach (var t in Model)
                                {
                                    string LabelCell(int? year, decimal? val)
                                    {
                                        var y = year?.ToString() ?? "â€”";
                                        var v = val.HasValue ? val.Value.ToString("0.###") : "â€”";
                                        // stacked, compact: year (muted) on top, value bold under it
                                        return $@"<div class=""d-flex flex-column lh-sm"">
                                                    <span class=""text-muted small"">{y}</span>
                                                    <span class=""fw-semibold"">{v}</span>
                                                  </div>";
                                    }

                                    var kpiLabel = ((t.Kpi?.KpiCode ?? "").Trim() == "" ? "" : (t.Kpi!.KpiCode + " â€” ")) +
                                                   (t.Kpi?.KpiName ?? "");
                                    <tr>
                                        <td>@kpiLabel</td>
                                        <td>@t.BaseYear</td>
                                        <td>@Html.Raw(LabelCell(t.Period1, t.Period1Value))</td>
                                        <td>@Html.Raw(LabelCell(t.Period2, t.Period2Value))</td>
                                        <td>@Html.Raw(LabelCell(t.Period3, t.Period3Value))</td>
                                        <td>@Html.Raw(LabelCell(t.Period4, t.Period4Value))</td>
                                        <td>@Html.Raw(LabelCell(t.Period5, t.Period5Value))</td>
                                        <td class="small text-muted">
                                            @t.CreatedDate?.ToString("yyyy-MM-dd") by @t.CreatedBy
                                        </td>
                                        <td>
                                            <a class="btn btn-sm btn-outline-primary rounded-3"
                                               href="@Url.Action("Edit", new { id = t.KpiFiveYearTargetId })">Edit</a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">No five-year targets yet.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
</div>