@using KPIMonitor.Services
@inject IAdminAuthorizer AdminAuthorizer
@{
    ViewData["Title"] = "President Board";
    var isAdmin = AdminAuthorizer.IsAdmin(User) || AdminAuthorizer.IsSuperAdmin(User);
}
<style>
    @* .alert-tint {
        background: #fff5f5 !important;
        border-color: #f8d7da !important;
        box-shadow: 0 2px 8px rgba(220, 53, 69, .10) !important;
    } *@
    .alert-tint .card-title, .alert-tint h6 { color: #842029; }
    #kpiCountBadge { font-weight: 700; font-size: 0.95rem; }
    .status-pill {
        display:inline-block; padding:.35rem .7rem; border-radius:999px; color:#fff; font-weight:700; font-size:.9rem;
        background:#6c757d;
    }
</style>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    // ---------------------------
    // Admin flag + helpers
    // ---------------------------
    const IS_ADMIN = @(isAdmin ? "true" : "false");
    const $  = (id) => document.getElementById(id);
    const qs = (sel, root=document) => root.querySelector(sel);
    const getJSON = (url) => fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => r.json());
    const getHTML = (url) => fetch(url, { headers: { 'Accept': 'text/html' } }).then(r => r.text());
    const ENABLE_DECISIONS = false; // keep off unless you want the last slide

    // antiforgery
    const anti = () => (qs('input[name="__RequestVerificationToken"]')?.value || '');

    // status pretty label (same mapping as RedBoard UI)
    function uiStatus(codeOrLabel) {
        const s = String(codeOrLabel || '').trim().toLowerCase();
        switch (s) {
            case 'green': case 'conforme': case 'ok': return 'Target Achieved';
            case 'orange': case 'rattrapage': case 'catching up': return 'On Forecast';
            case 'red': case 'ecart': case 'needs attention': return 'Target Missed';
            case 'blue': case 'attente': case 'data missing': return 'Data Missing (No Changes)';
            default: return '‚Äî';
        }
    }

    // strip/disable admin-only controls in injected Actions HTML
    function stripAdminControlsInActions() {
        if (IS_ADMIN) return;
        const root = $('actionsList');
        if (!root) return;
        root.querySelectorAll('[data-action="move-deadline"],[data-action="delete-action"],[data-action="close-action"],[data-action="edit-action"],[data-admin-only],[asp-admin-only]')
            .forEach(n => n.remove());
        root.querySelectorAll('select[data-action="set-status"]').forEach(sel => { sel.disabled = true; sel.classList.add('disabled'); sel.title = 'Admins only'; });
        root.querySelectorAll('.btn-group, .ap-actions, .card-actions').forEach(g => { if (!g.querySelector('button,a,select')) g.remove(); });
    }

    // deck state
    let allList = []; // [{kpiId, name, code, priority}]
    let deck = [];    // title + kpi slides (+ decisions if enabled)
    let idx = 0;
    let kpiChart;
    let currentKpiId = null;
    let runKpiIds = [];

    function _fmtShort(v) {
        const n = Number(v); if (!isFinite(n)) return '';
        const a = Math.abs(n);
        if (a >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'') + 'B';
        if (a >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M';
        if (a >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'') + 'K';
        return n.toString();
    }

    // smart value labels (same as RedBoard)
    const SmartValueLabels = {
        id:'smartValueLabels',
        afterDatasetsDraw(chart,_args,o){
            const {ctx,data,chartArea}=chart; const opt=o||{};
            const fmt = typeof opt.formatter==='function'?opt.formatter:(v)=>String(v);
            const fs=opt.fontSize||12, fw=opt.fontWeight||'700', minGap=opt.minGap||14, pt=opt.padTop||4, pb=opt.padBottom||4, maxShift=opt.maxShift||40;
            const barDY=(opt.barDY!=null?opt.barDY:-12), barDYNeg=(opt.barDYNeg!=null?opt.barDYNeg:14), lineDY=(opt.lineDY!=null?opt.lineDY:-12);
            const perDataset=opt.perDataset||[], onlyLast=!!opt.onlyLastForLines, lineStep=opt.lineStep||1;
            ctx.save(); ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.font=`${fw} ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
            const byIndex=new Map();
            data.datasets.forEach((ds,di)=>{
                if(!chart.isDatasetVisible(di)) return;
                const meta=chart.getDatasetMeta(di), type=ds.type||meta.type, isBar=type==='bar', isLine=type==='line', per=perDataset[di]||{}, step=Number.isInteger(per.step)?Math.max(1,per.step):lineStep;
                let last=null;
                if(isLine&&(onlyLast||per.onlyLast)){ for(let i=ds.data.length-1;i>=0;i--){ const v=ds.data[i]; if(v!=null && !Number.isNaN(+v)){ last=i; break;} } }
                meta.data.forEach((el,i)=>{
                    const raw=ds.data[i], val=Number(raw); if(raw==null || Number.isNaN(val)) return;
                    if(isLine){ if((onlyLast||per.onlyLast)&&i!==last) return; if((i%step)!==0) return; }
                    const {x,y}=el.getProps(['x','y'],true);
                    let dy=isBar?(val<0?barDYNeg:barDY):lineDY; if(typeof per.dy==='number') dy=per.dy; const dx=(typeof per.dx==='number')?per.dx:0;
                    const text=fmt(val); const w=ctx.measureText(text).width, h=fs*1.2;
                    const item={x:x+dx,y:y+dy,baseY:y+dy,val,text,color:per.color||opt.color||'#111',w,h,priority:isBar?0:1};
                    const arr=byIndex.get(i); if(arr) arr.push(item); else byIndex.set(i,[item]);
                });
            });
            const top=chartArea.top+pt, bot=chartArea.bottom-pb;
            byIndex.forEach(items=>{
                const clamp=(it)=>{ const t=top+it.h; if(it.y<t) it.y=t; const low=it.baseY-maxShift, high=it.baseY+maxShift; if(it.y<low) it.y=low; if(it.y>high) it.y=high; if(it.y>bot) it.y=bot; };
                items.forEach(it=>{ it.y=it.baseY; clamp(it); });
                let guard=0; while(guard++<10){ let changed=false;
                    for(let i=0;i<items.length;i++){ for(let j=i+1;j<items.length;j++){
                        const a=items[i], b=items[j];
                        const aL=a.x-a.w/2, aR=a.x+a.w/2, aT=a.y-a.h, aB=a.y;
                        const bL=b.x-b.w/2, bR=b.x+b.w/2, bT=b.y-b.h, bB=b.y;
                        const overlap=!(aR<bL||aL>bR||aB<bT||aT>bB);
                        if(overlap){ const hi=(a.val>=b.val)?a:b, lo=(hi===a)?b:a; hi.y-=minGap; lo.y+=Math.min(4,minGap/2); clamp(hi); clamp(lo); changed=true; }
                    }}
                    if(!changed) break;
                }
                items.sort((a,b)=>a.priority-b.priority);
                const {ctx}=chart; items.forEach(it=>{ ctx.fillStyle=it.color; if(opt.outline){ ctx.lineWidth=3; ctx.strokeStyle='rgba(255,255,255,0.95)'; ctx.strokeText(it.text,it.x,it.y);} ctx.fillText(it.text,it.x,it.y); });
            });
            ctx.restore();
        }
    };
    Chart.register(SmartValueLabels);
    Chart.register(ChartDataLabels);

    // load list + build deck
    async function loadAllList() {
        allList = await getJSON('@Url.Action("GetKpiIds", "PresidentBoard")');
        const badge = $('kpiCountBadge');
        if (badge) {
            const n = Array.isArray(allList) ? allList.length : 0;
            badge.textContent = `${n} KPI${n === 1 ? '' : 's'}`;
            badge.classList.toggle('d-none', n === 0);
        }

        if (!allList || allList.length === 0) {
            $('emptyMsg').classList.remove('d-none');
            $('slideWrap').classList.add('d-none');
            return;
        }
        $('emptyMsg').classList.add('d-none');
        $('slideWrap').classList.remove('d-none');

        const groups = new Map();
        for (const k of allList) {
            const key = k.priority ?? 999999;
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(k);
        }
        const orderedPriorities = Array.from(groups.keys()).sort((a,b)=>a-b);

        deck = [];
        runKpiIds = [];
        for (const p of orderedPriorities) {
            const items = groups.get(p);
            deck.push({ type: 'title', priority: p === 999999 ? '‚Äî' : p, count: items.length });
            for (const k of items) {
                deck.push({ type: 'kpi', ...k });
                runKpiIds.push(k.kpiId);
            }
        }
        if (ENABLE_DECISIONS) deck.push({ type: 'decisions' });

        idx = 0;
        await showCurrent();
    }

    async function showCurrent() {
        const slide = deck[idx];
        $('slideCounter').innerText = `${idx + 1} / ${deck.length}`;
        $('decisionsWrap').classList.add('d-none');

        const isLast = (idx === deck.length - 1);
        const isFirst = (idx === 0);
        $('btnFirst') && ($('btnFirst').disabled = isFirst);
        $('btnLast') && ($('btnLast').disabled = isLast);

        if (slide.type === 'decisions' && ENABLE_DECISIONS) {
            $('titleSlide').classList.add('d-none');
            $('kpiSlide').classList.add('d-none');
            $('actionsBlock').classList.add('d-none');
            await showDecisions();
            return;
        }

        if (slide.type === 'title') {
            $('kpiHeading').innerText = `Priority ${slide.priority}`;
            $('kpiSub').innerText = `${slide.count} KPI${slide.count === 1 ? '' : 's'}`;
            $('titlePriority').textContent = slide.priority;

            $('titleSlide').classList.remove('d-none');
            $('kpiSlide').classList.add('d-none');
            $('actionsBlock').classList.add('d-none');
            return;
        }

        // KPI slide
        $('titleSlide').classList.add('d-none');
        $('kpiSlide').classList.remove('d-none');
        $('actionsBlock').classList.remove('d-none');

        currentKpiId = slide.kpiId;
        $('kpiHeading').innerText = `KPI Name: ${slide.name}`;
        $('kpiSub').innerText = `${slide.code}`;

        // Add Action visibility (admin only ‚Äî button exists but disabled/hidden for non-admin)
        const addBtn = $('btnAddAction');
        if (addBtn) {
            addBtn.disabled = !IS_ADMIN;
            addBtn.classList.toggle('d-none', !IS_ADMIN);
        }

        const data = await getJSON('@Url.Action("GetKpiPresentation", "PresidentBoard")?kpiId=' + slide.kpiId);

        // meta
        $('m_owner').innerText = data?.meta?.owner ?? '‚Äî';
        $('m_editor').innerText = data?.meta?.editor ?? '‚Äî';
        $('m_frequency').innerText = data?.meta?.valueType ?? '‚Äî';
        $('m_unit').innerText = data?.meta?.unit ?? '‚Äî';
        $('m_priority').innerText = data?.meta?.priority ?? '‚Äî';
        const status = $('m_status');
        status.innerText = uiStatus(data?.meta?.statusLabel);
        status.style.background = data?.meta?.statusColor ?? '';
        status.className = 'status-pill';

        // chart
        const baseLabels = data?.chart?.labels || [];
        const act = data?.chart?.actual || [];
        const tgt = data?.chart?.target || [];
        const fct = data?.chart?.forecast || [];
        const yrs = Array.isArray(data?.chart?.yearTargets) ? data.chart.yearTargets : [];
        const yearLabels = yrs.map(y => String(y.year));
        const yearVals = yrs.map(y => y.value ?? null);
        const allLabels = baseLabels.concat(yearLabels);
        const pad = new Array(yearLabels.length).fill(null);
        const leftNulls = new Array(baseLabels.length).fill(null);

        const chartData = {
            labels: allLabels,
            datasets: [
                { type: 'bar', label: 'Actual',   data: act.concat(pad), backgroundColor: '#800080', borderColor: '#800080', borderWidth: 2, borderSkipped: 'bottom' },
                { type: 'line', label: 'Target',   data: tgt.concat(pad), borderColor: '#7a7a7a', pointBackgroundColor: '#7a7a7a', pointBorderColor: '#7a7a7a', borderWidth: 2, tension: .3, fill: false },
                { type: 'line', label: 'Forecast', data: fct.concat(pad), borderColor: '#fd7e14', pointBackgroundColor: '#fd7e14', pointBorderColor: '#fd7e14', borderDash: [5,5], borderWidth: 2, tension: .3, fill: false },
                { type: 'bar', label: 'Year Target', data: leftNulls.concat(yearVals), backgroundColor: '#7a7a7a', borderColor: '#7a7a7a', borderWidth: 1 }
            ]
        };

        if (!kpiChart) {
            kpiChart = new Chart($('pbChart').getContext('2d'), {
                data: chartData,
                options: {
                    responsive:true, maintainAspectRatio:false, layout:{ padding:{ top:28, bottom:8 } },
                    scales:{ x:{ grid:{ display:false }, ticks:{ padding:8, callback:function(v){ return String(this.getLabelForValue(v)).replace(/^\s*\d{4}\s*[\-‚Äì‚Äî]\s*/, ''); } } }, y:{ display:false, grid:{ display:false }, beginAtZero:true } },
                    plugins:{
                        datalabels:false,
                        smartValueLabels:{
                            formatter:_fmtShort, fontSize:12, fontWeight:'700', minGap:14, padTop:12, padBottom:4, outline:true,
                            perDataset:[{ dy:-12,dx:0,color:'#800080' },{ dy:12,dx:-8,color:'#7a7a7a' },{ dy:-16,dx:8,color:'#fd7e14' },{ dy:-12,dx:0,color:'#7a7a7a' }]
                        },
                        tooltip:{ enabled:true },
                        legend:{ position:'top', labels:{ boxWidth:12, boxHeight:10, padding:12, font:{ size:8, weight:'700' } } }
                    }
                }
            });
        } else {
            kpiChart.data = chartData;
            kpiChart.update();
        }

        await loadActionsHtml(slide.kpiId);
    }

    window.prevSlide  = async () => { if (!deck.length) return; idx = (idx - 1 + deck.length) % deck.length; await showCurrent(); }
    window.nextSlide  = async () => { if (!deck.length) return; idx = (idx + 1) % deck.length; await showCurrent(); }
    window.firstSlide = async () => { if (!deck.length) return; idx = 0; await showCurrent(); }
    window.lastSlide  = async () => { if (!deck.length) return; idx = deck.length - 1; await showCurrent(); }

    async function loadActionsHtml(kpiId) {
        $('actionsList').innerHTML = "<div class='text-muted small'>Loading‚Ä¶</div>";
        try {
            const html = await getHTML('@Url.Action("ActionsListHtml", "PresidentBoard")?kpiId=' + encodeURIComponent(kpiId));
            $('actionsList').innerHTML = html;
            stripAdminControlsInActions();
        } catch {
            $('actionsList').innerHTML = "<div class='text-danger small'>Failed to load actions.</div>";
        }
    }

    // delegate clicks for move deadline (admin only)
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        if (btn.getAttribute('data-action') === 'move-deadline') {
            if (!IS_ADMIN) return;
            openMoveDeadline(btn.getAttribute('data-id'));
        }
    });

    // delegate change for status dropdowns (admin only) ‚Äî uses your existing KpiActions controller
    document.addEventListener('change', async (e) => {
        const sel = e.target.closest('select[data-action="set-status"]');
        if (!sel) return;
        if (!IS_ADMIN) { sel.value = sel.getAttribute('data-current') || sel.value; return; }
        const id = sel.getAttribute('data-id');
        const val = sel.value;
        try {
            const fd = new FormData();
            fd.append('__RequestVerificationToken', anti());
            fd.append('actionId', id);
            fd.append('statusCode', val);
            const res = await fetch('@Url.Action("SetStatus","KpiActions")', { method:'POST', body:fd, headers:{ 'Accept':'text/html','X-Requested-With':'XMLHttpRequest' } });
            if (!res.ok) throw 0;
            await loadActionsHtml(currentKpiId);
        } catch { alert('Failed to update status.'); }
    });

    // Add Action modal (admin only) ‚Äî posts to your existing KpiActions controller (Create / CreateGeneral)
    function openAddAction() {
        if (!IS_ADMIN) return;
        if (!currentKpiId) return;
        $('af_kpiId').value = currentKpiId;
        $('af_owner').value = '';
        $('af_description').value = '';
        $('af_due').value = '';
        $('af_status').value = 'todo';
        new bootstrap.Modal(document.getElementById('addActionModal')).show();
    }
    async function submitAddAction(ev) {
        ev.preventDefault();
        if (!IS_ADMIN) return;
        try {
            await fetch('@Url.Action("Create", "KpiActions")', { method:'POST', body:new FormData($('addActionForm')), headers:{ 'Accept':'text/html','X-Requested-With':'XMLHttpRequest' } });
            bootstrap.Modal.getInstance(document.getElementById('addActionModal')).hide();
            await loadActionsHtml(currentKpiId);
        } catch { alert('Save failed.'); }
    }

    function openMoveDeadline(actionId) {
        if (!IS_ADMIN) return;
        $('md_actionId').value = actionId;
        $('md_reason').value = '';
        $('md_due').value = '';
        new bootstrap.Modal(document.getElementById('moveDeadlineModal')).show();
    }
    async function submitMoveDeadline(ev) {
        ev.preventDefault();
        if (!IS_ADMIN) return;
        try {
            await fetch('@Url.Action("MoveDeadline", "KpiActions")', { method:'POST', body:new FormData($('moveDeadlineForm')), headers:{ 'Accept':'text/html','X-Requested-With':'XMLHttpRequest' } });
            bootstrap.Modal.getInstance(document.getElementById('moveDeadlineModal')).hide();
            await loadActionsHtml(currentKpiId);
        } catch { alert('Failed to move deadline (check max 3 extensions).'); }
    }

    async function showDecisions() {
        if (!runKpiIds.length) return;
        $('decisionsWrap').classList.remove('d-none');
        $('decisionsBody').innerHTML = "<div class='text-muted small'>Loading‚Ä¶</div>";
        try {
            const res = await fetch('@Url.Action("DecisionsBoardHtml", "PresidentBoard")', {
                method:'POST',
                headers:{ 'Accept':'text/html','Content-Type':'application/json','RequestVerificationToken': anti() },
                body: JSON.stringify(runKpiIds)
            });
            if (!res.ok) throw 0;
            $('decisionsBody').innerHTML = await res.text();
            $('decisionsWrap').scrollIntoView({ behavior:'smooth', block:'start' });
            stripAdminControlsInActions();
        } catch { $('decisionsBody').innerHTML = "<div class='text-danger small'>Failed to load decisions.</div>"; }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAllList();
        window.submitAddAction = submitAddAction;
        window.submitMoveDeadline = submitMoveDeadline;
        window.openAddAction = openAddAction;
        window.openMoveDeadline = openMoveDeadline;
        window.showDecisions = showDecisions;
    });
</script>
}

<div class="container py-4">
    @section PageHeader {
        <div class="page-hero" style="background-image:url('@Url.Content("~/images/pic1.jpg")')">
            <div class="page-hero-content">
                <h1 class="page-title">All KPIs ‚Äî Slideshow</h1>
            </div>
        </div>
    }
    <div class="with-rails">
        <form id="af" method="post" class="d-none">@Html.AntiForgeryToken()</form>

        <div id="emptyMsg" class="alert alert-secondary rounded-4 d-none">
            No KPIs are available.
        </div>

        <div id="slideWrap" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="me-2">
                    <div class="h4 mb-0 fw-bold" id="kpiHeading">‚Äî</div>
                    <div class="text-muted" id="kpiSub" style="white-space:pre-line;">‚Äî</div>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted" id="slideCounter">0 / 0</span>
                    <span id="kpiCountBadge" class="badge rounded-pill text-bg-primary d-none px-3 py-2">0 KPIs</span>
                    <button id="btnFirst" class="btn btn-outline-secondary" type="button" onclick="firstSlide()" title="First">‚èÆ</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="prevSlide()">‚óÄ</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="nextSlide()">‚ñ∂</button>
                    <button id="btnLast" class="btn btn-outline-secondary" type="button" onclick="lastSlide()" title="Last">‚è≠</button>
                </div>
            </div>

            <!-- Title slide -->
            <div id="titleSlide" class="text-center py-5 d-none">
                <div class="bg-white border rounded shadow-sm p-5">
                    <div class="display-4 fw-bold mb-3">Priority</div>
                    <div class="display-1 fw-bolder" id="titlePriority"></div>
                    <div class="lead text-muted mt-3">Use the arrows to view KPIs in this priority.</div>
                </div>
            </div>

            <!-- KPI slide -->
            <div id="kpiSlide">
                <div class="row g-4 mb-4">
                    <div class="col-md-9">
                        <div class="bg-white border rounded shadow-sm p-3 alert-tint" style="height:550px;">
                            <canvas id="pbChart" role="img" aria-label="KPI Chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex">
                        <div class="card shadow-sm rounded-3 w-100">
                            <div class="card-body d-flex flex-column justify-content-between h-100">
                                <div>
                                    <h6 class="card-title text-secondary fw-bold mb-3">KPI Details</h6>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>üëÅÔ∏è Owner:</strong> <span id="m_owner" class="text-dark">‚Äî</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>‚úçÔ∏è Editor:</strong> <span id="m_editor" class="text-dark">‚Äî</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>üìÖ Frequency:</strong> <span id="m_frequency" class="text-dark">‚Äî</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>üî¢ Unit:</strong> <span id="m_unit" class="text-dark">‚Äî</span>
                                    </p>
                                </div>
                                <div class="mt-auto">
                                    <div class="mb-4 text-center">
                                        <div class="text-muted">Priority</div>
                                        <div id="m_priority" class="display-6 fw-bold text-dark">‚Äî</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted mb-1">Status</div>
                                        <span id="m_status" class="status-pill">‚Äî</span>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button id="btnAddAction" class="btn btn-primary@(isAdmin ? "" : " d-none")"
                                            type="button" onclick="openAddAction()" disabled>
                                            ‚ûï Add Action
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- /col -->
                </div> <!-- /row -->
            </div> <!-- /kpiSlide -->

            <!-- Actions block (HTML injected) -->
            <div id="actionsBlock" class="mt-3 d-none">
                <div class="bg-white border rounded-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 text-secondary fw-bold">Actions for this KPI</h6>
                    </div>
                    <div id="actionsList"></div>
                </div>
            </div>

            <!-- Decisions board (optional) -->
            <div id="decisionsWrap" class="mt-4 d-none">
                <div class="bg-white border rounded-3 p-3">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0">Decisions</h5>
                        <button id="btnAddGeneralAction" type="button" class="btn btn-primary btn-sm@(isAdmin ? "" : " d-none")">
                            Add General Action
                        </button>
                    </div>
                    <div id="decisionsBody"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Action Modal -->
    <div class="modal fade" id="addActionModal" tabindex="-1" aria-labelledby="addActionLabel" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content rounded-3">
            <div class="modal-header">
                <h5 class="modal-title" id="addActionLabel">Add Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addActionForm" method="post" onsubmit="submitAddAction(event)">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="KpiId" id="af_kpiId" />
                    <div class="mb-3">
                        <label class="form-label">Owner</label>
                        <input class="form-control" name="Owner" id="af_owner" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assigned At</label>
                        <input type="datetime-local" class="form-control" name="AssignedAt" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <textarea class="form-control" name="Description" id="af_description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Due Date</label>
                        <input type="datetime-local" class="form-control" name="DueDate" id="af_due" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="StatusCode" id="af_status">
                            <option value="todo">To Do</option>
                            <option value="inprogress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </div>
                    <input type="hidden" name="ExtensionCount" value="0" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Action</button>
                </div>
            </form>
        </div></div>
    </div>

    <!-- Move Deadline Modal -->
    <div class="modal fade" id="moveDeadlineModal" tabindex="-1" aria-labelledby="moveDeadlineLabel" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content rounded-3">
            <div class="modal-header">
                <h5 class="modal-title" id="moveDeadlineLabel">Move Deadline</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="moveDeadlineForm" method="post" onsubmit="submitMoveDeadline(event)">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" name="actionId" id="md_actionId" />
                    <div class="mb-3">
                        <label class="form-label">New Due Date</label>
                        <input type="datetime-local" class="form-control" name="newDueDate" id="md_due" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason (optional)</label>
                        <textarea class="form-control" name="reason" id="md_reason" rows="2"></textarea>
                    </div>
                    <div class="text-muted small">Max 3 extensions enforced.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Move</button>
                </div>
            </form>
        </div></div>
    </div>
</div>
