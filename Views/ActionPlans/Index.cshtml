@using KPIMonitor.Services
@inject IAdminAuthorizer AdminAuthorizer
@inject IEmployeeDirectory EmpDir
@{
  ViewData["Title"] = "Action Plans";
  var isAdmin = AdminAuthorizer.IsAdmin(User) || AdminAuthorizer.IsSuperAdmin(User);

  // Pull ALL employees once at render (no filtering or preselection)
  // EmployeePickDto => EmpId, Label
  var employees = await EmpDir.GetAllForPickAsync();
}

<style>
  .ap-action-btn {
    min-width: 90px;
    padding: .20rem .45rem;
    font-size: 0.75rem;
    line-height: 1.1;
    white-space: nowrap;
  }

  .ap-colbadge {
    font-size: 0.95rem;
    padding: .5rem .75rem;
    letter-spacing: .1px;
  }

  .ap-col {
    display: flex;
    flex-direction: column;
    gap: .75rem;
  }

  .ap-col-header {
    width: 100%;
    border-radius: .75rem;
    padding: .45rem .75rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .ap-col-header--todo {
    background: #6c757d;
    color: #fff;
  }

  .ap-col-header--prog {
    background: #ffc107;
    color: #000;
  }

  .ap-col-header--done {
    background: #198754;
    color: #fff;
  }

  #apBody,
  #apBody .row,
  #apBody .col-md-4 {
    overflow: visible;
  }

  .ap-scroll {
    max-height: calc(100vh - 220px);
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
  }

  @@media (min-width: 992px) {
    .ap-col-header {
      position: sticky;
      top: 0;
      z-index: 5;
    }
  }
</style>

<div class="container py-4">
  @section PageHeader {
    <div class="page-hero" style="background-image:url('@Url.Content("~/images/pic1.jpg")')">
      <div class="page-hero-content">
        <h1 class="page-title">Action Plans</h1>
      </div>
    </div>
  }

  <div class="with-rails">
    <!-- hidden antiforgery to reuse in JS -->
    <form id="af" method="post" class="d-none">
      @Html.AntiForgeryToken()
    </form>

    @if (isAdmin)
    {
      <div class="d-flex justify-content-end mb-3">
        <button type="button" class="btn btn-sm btn-primary" id="apAddBtn">
          + Add action plan
        </button>
      </div>
    }

    <div id="apBody" class="bg-white border rounded-3 p-3">
      <div class="text-muted small">Loading…</div>
    </div>
  </div>
</div>

<!-- Move Deadline Modal -->
<div class="modal fade" id="moveDeadlineModal" tabindex="-1" aria-labelledby="moveDeadlineLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="moveDeadlineLabel">Move Deadline</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="moveDeadlineForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <input type="hidden" name="actionId" id="md_actionId" />
          <div class="mb-3">
            <label class="form-label">New Due Date</label>
            <input type="datetime-local" class="form-control" name="newDueDate" id="md_due" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Reason (optional)</label>
            <textarea class="form-control" name="reason" id="md_reason" rows="2"></textarea>
          </div>
          <div class="text-muted small">Max 3 Extensions.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Move</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Plan Modal -->
<div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="editPlanLabel">Edit Action Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="editPlanForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <input type="hidden" name="actionId" id="ep_actionId" />

          <div class="mb-3">
            <label class="form-label">Owners</label>

            <div class="d-flex gap-2">
              <select class="form-select" id="ep_ownerPick">
                <option value="">— Select —</option>
                @foreach (var e in employees ?? Enumerable.Empty<KPIMonitor.ViewModels.EmployeePickDto>())
                {
                  var display = e.Label ?? "";
                  var idx = display.IndexOf('(');
                  if (idx > 0) { display = display.Substring(0, idx).Trim(); }
                  <option value="@e.EmpId">@display</option>
                }
              </select>

              <button type="button" class="btn btn-outline-secondary" id="ep_addOwnerBtn">Add</button>
            </div>

            <div class="form-text">
              Add one or more owners. The tile will display: <strong>First Owner (+N)</strong>.
            </div>

            <div id="ep_ownerList" class="mt-2 d-flex flex-wrap gap-2"></div>

            <input type="hidden" name="owner" id="ep_ownerDisplay" />
            <div id="ep_ownerEmpIds"></div>
          </div>

          <div class="mb-3">
            <label class="form-label">Assigned At</label>
            <input type="datetime-local" class="form-control" name="assignedAt" id="ep_assignedAt" />
          </div>

          <div class="mb-3">
            <label class="form-label">Due Date</label>
            <input type="datetime-local" class="form-control" name="dueDate" id="ep_due" />
          </div>

          <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="statusCode" id="ep_status">
              <option value="todo">To Do</option>
              <option value="inprogress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" id="ep_desc" rows="3" required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Archive Action Plan Modal -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="archiveLabel">Archive action plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="archiveForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <input type="hidden" name="actionId" id="arc_actionId" />
          <p class="mb-0">Are you sure you want to archive this action plan?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Archive</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Action Plan Modal -->
<div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="addPlanLabel">Add Action Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="addPlanForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="ap_isGeneral" checked>
            <label class="form-check-label" for="ap_isGeneral">
              General action (not tied to a KPI)
            </label>
          </div>

          <div class="mb-3" id="ap_kpiBlock">
            <label class="form-label">Link to KPI</label>
            <div class="row g-2">
              <div class="col-md-4">
                <select class="form-select" id="ap_pillar">
                  <option value="">— Pillar —</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select" id="ap_objective" disabled>
                  <option value="">— Objective —</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select" id="ap_kpi" name="KpiId" disabled>
                  <option value="">— KPI —</option>
                </select>
              </div>
            </div>
            <div class="form-text">
              Leave as <em>General</em> above if this action is not for a specific KPI.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Owners</label>

            <div class="d-flex gap-2">
              <select class="form-select" id="ap_ownerPick">
                <option value="">— Select —</option>
                @foreach (var e in employees ?? Enumerable.Empty<KPIMonitor.ViewModels.EmployeePickDto>())
                {
                  var display = e.Label ?? "";
                  var idx = display.IndexOf('(');
                  if (idx > 0) { display = display.Substring(0, idx).Trim(); }
                  <option value="@e.EmpId">@display</option>
                }
              </select>

              <button type="button" class="btn btn-outline-secondary" id="ap_addOwnerBtn">Add</button>
            </div>

            <div class="form-text">
              Add one or more owners. The tile will display: <strong>First Owner (+N)</strong>.
            </div>

            <div id="ap_ownerList" class="mt-2 d-flex flex-wrap gap-2"></div>
            <input type="hidden" name="Owner" id="ap_ownerDisplay" />
            <div id="ap_ownerEmpIds"></div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Assigned at</label>
              <input type="datetime-local" class="form-control" name="AssignedAt" id="ap_assignedAt" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Due date</label>
              <input type="datetime-local" class="form-control" name="DueDate" id="ap_due" />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="StatusCode" id="ap_status">
              <option value="todo">To Do</option>
              <option value="inprogress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="Description" id="ap_desc" rows="3" required></textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Action Details + Comments Modal (NEW) -->
<div class="modal fade" id="apDetailsModal" tabindex="-1" aria-labelledby="apDetailsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="apDetailsLabel">Action Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="ad_actionId" />

        <div class="mb-2">
          <div class="text-muted small">Owners</div>
          <div id="ad_owners" class="fw-semibold">—</div>
        </div>

        <div class="row g-2 mb-2">
          <div class="col-md-6">
            <div class="text-muted small">Status</div>
            <div id="ad_status" class="fw-semibold">—</div>
          </div>
          <div class="col-md-6">
            <div class="text-muted small">Due</div>
            <div id="ad_due" class="fw-semibold">—</div>
          </div>
        </div>

        <div class="mb-3">
          <div class="text-muted small">Description</div>
          <div id="ad_desc" class="border rounded-2 p-2 bg-light">—</div>
        </div>

        <hr class="my-3" />

        <div id="ad_commentsAnchor"></div>

        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0">Comments</h6>
          <div class="text-muted small" id="ad_commentHint"></div>
        </div>

        <div id="ad_commentsList" class="d-flex flex-column gap-2 mb-3">
          <div class="text-muted small">Loading…</div>
        </div>

        <div id="ad_addCommentBlock" class="border rounded-3 p-2">
          <div class="mb-2">
            <textarea class="form-control" id="ad_commentText" rows="3" placeholder="Write a comment..."></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-primary btn-sm" id="ad_postCommentBtn">Post</button>
          </div>
          <div class="fw-bold small mt-1">Once posted, comments cannot be edited.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    const IS_ADMIN = @(isAdmin ? "true" : "false");
    const $ = (id) => document.getElementById(id);
    const qs = (sel, root = document) => root.querySelector(sel);
    const anti = () => (qs('input[name="__RequestVerificationToken"]')?.value || '');

    const getJSON = (url) => fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });

    function setBtnLoading(btn, loading, textOverride) {
      if (!btn) return;

      if (loading) {
        if (!btn.dataset.origHtml) btn.dataset.origHtml = btn.innerHTML;

        btn.disabled = true;
        btn.classList.add('disabled');
        btn.style.opacity = '0.75';

        const label = textOverride || btn.textContent.trim() || 'Saving';
        btn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            ${label}...
          `;
      } else {
        btn.disabled = false;
        btn.classList.remove('disabled');
        btn.style.opacity = '';
        if (btn.dataset.origHtml) btn.innerHTML = btn.dataset.origHtml;
      }
    }

    function withFormLoading(formEl, asyncFn, label) {
      const submitBtn = formEl?.querySelector('button[type="submit"]');
      return (async () => {
        try {
          setBtnLoading(submitBtn, true, label);
          await asyncFn();
        } finally {
          setBtnLoading(submitBtn, false);
        }
      })();
    }

    let apKpiIds = [];

    /* -------------------------
       Board rendering helpers
    ------------------------- */
    function stripAdminControls() {
      if (IS_ADMIN) return;
      const root = $('apBody');
      if (!root) return;

      const selectors = [
        '[data-action="move-deadline"]',
        '[data-action="edit-plan"]',
        '[data-action="delete-action"]',
        '[data-action="close-action"]',
        '[data-action="archive-action"]',
        '[data-admin-only]',
        '[asp-admin-only]'
      ];
      selectors.forEach(sel => { root.querySelectorAll(sel).forEach(n => n.remove()); });
    }

    async function refreshBoard() {
      try {
        const res = await fetch('@Url.Action("BoardHtml", "ActionPlans")', {
          method: 'POST',
          headers: {
            'Accept': 'text/html',
            'Content-Type': 'application/json',
            'RequestVerificationToken': anti()
          },
          body: JSON.stringify(apKpiIds)
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);
        $('apBody').innerHTML = "<div class='ap-scroll'>" + (await res.text()) + "</div>";
        stripAdminControls();
      } catch (err) {
        console.error('[AP] BoardHtml failed:', err);
        $('apBody').innerHTML = "<div class='text-danger small'>Failed to load actions.</div>";
      }
    }

    /* -------------------------
       Owners (multi-select) helpers
       Used by BOTH Edit + Add modals
    ------------------------- */
    function buildEmpMap(selectEl) {
      const map = new Map();
      if (!selectEl) return map;

      Array.from(selectEl.options).forEach(o => {
        const id = (o.value || '').trim();
        const name = (o.textContent || '').trim();
        if (id) map.set(id, name);
      });
      return map;
    }

    function uniqIds(arr) {
      return Array.from(new Set((arr || []).map(x => (x || '').trim()).filter(Boolean)));
    }

    function renderOwners(prefix, ownerEmpIds) {
      const list = $(`${prefix}_ownerList`);
      const hidden = $(`${prefix}_ownerEmpIds`);
      const display = $(`${prefix}_ownerDisplay`);
      const pick = $(`${prefix}_ownerPick`);
      if (!list || !hidden || !display) return;

      const empMap = buildEmpMap(pick);
      const ids = uniqIds(ownerEmpIds);

      list.innerHTML = '';
      hidden.innerHTML = '';

      ids.forEach(empId => {
        const name = empMap.get(empId) || empId;

        const pill = document.createElement('span');
        pill.className = 'badge rounded-pill text-bg-light border';
        pill.style.padding = '.5rem .6rem';
        pill.innerHTML = `
            <span class="me-2">${name}</span>
            <button type="button" class="btn btn-sm btn-link p-0 text-danger"
                    data-remove-owner="${empId}" data-owner-prefix="${prefix}"
                    style="text-decoration:none;">✕</button>
          `;
        list.appendChild(pill);

        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = 'ownerEmpIds';
        inp.value = empId;
        hidden.appendChild(inp);
      });

      if (ids.length === 0) {
        display.value = '';
      } else {
        const firstName = empMap.get(ids[0]) || ids[0];
        display.value = ids.length > 1 ? `${firstName} (+${ids.length - 1})` : `${firstName}`;
      }
    }

    function currentOwners(prefix) {
      const hidden = $(`${prefix}_ownerEmpIds`);
      if (!hidden) return [];
      return Array.from(hidden.querySelectorAll('input[name="ownerEmpIds"]'))
        .map(i => (i.value || '').trim())
        .filter(Boolean);
    }

    function addOwner(prefix) {
      const pick = $(`${prefix}_ownerPick`);
      if (!pick) return;

      const empId = (pick.value || '').trim();
      if (!empId) return;

      const cur = currentOwners(prefix);
      if (cur.some(x => x.toLowerCase() === empId.toLowerCase())) return;

      cur.push(empId);
      renderOwners(prefix, cur);
      pick.value = '';
    }

    /* -------------------------
       Details/Comments helpers (NEW)
    ------------------------- */
    function escapeHtml(s) {
      return (s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function formatLocal(dt) {
      if (!dt) return '—';
      return (dt || '').replace('T', ' ');
    }

    function renderCommentItem(c) {
      const author = escapeHtml(c.authorName || c.authorEmpId || '—');
      const when = escapeHtml(c.createdAtLocal || '');
      const text = escapeHtml(c.text || '');

      return `
          <div class="border rounded-3 p-2 bg-white">
            <div class="d-flex justify-content-between">
              <div class="fw-semibold">${author}</div>
              <div class="text-muted small">${when}</div>
            </div>
            <div class="mt-1">${text}</div>
          </div>
        `;
    }

    async function openActionDetails(actionId, opts) {
      const focusComments = !!opts?.focusComments;

      $('ad_actionId').value = actionId;
      $('ad_owners').textContent = '—';
      $('ad_status').textContent = '—';
      $('ad_due').textContent = '—';
      $('ad_desc').textContent = '—';
      $('ad_commentsList').innerHTML = `<div class="text-muted small">Loading…</div>`;
      $('ad_commentText').value = '';
      $('ad_commentHint').textContent = '';

      const modalEl = document.getElementById('apDetailsModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();

      try {
        const d = await getJSON('@Url.Action("GetActionDetails", "KpiActions")?actionId=' + encodeURIComponent(actionId));

        $('ad_owners').textContent = (d.ownersText || '—');
        $('ad_status').textContent = d.statusText || d.statusCode || '—';
        $('ad_due').textContent = formatLocal(d.dueDateLocal || '');
        $('ad_desc').textContent = d.description || '—';

        const canComment = !!d.canComment;
        $('ad_addCommentBlock').style.display = canComment ? '' : 'none';
        $('ad_commentHint').textContent = canComment ? '' : 'Only owners can post comments.';

        const comments = await getJSON('@Url.Action("GetActionComments", "KpiActions")?actionId=' + encodeURIComponent(actionId));
        if (!comments || comments.length === 0) {
          $('ad_commentsList').innerHTML = `<div class="text-muted small">No comments yet.</div>`;
        } else {
          $('ad_commentsList').innerHTML = comments.map(renderCommentItem).join('');
        }

        if (focusComments) {
          $('ad_commentsAnchor')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
          if ($('ad_addCommentBlock').style.display !== 'none') {
            setTimeout(() => $('ad_commentText')?.focus(), 200);
          }
        }
      } catch (err) {
        console.error('[AP] openActionDetails failed:', err);
        $('ad_commentsList').innerHTML = `<div class="text-danger small">Failed to load details.</div>`;
      }
    }

    /* -------------------------
       Global event listeners
    ------------------------- */
    document.addEventListener('DOMContentLoaded', refreshBoard);

    // IMPORTANT: prevent tile click when clicking buttons inside tiles
    // IMPORTANT: prevent tile click when clicking buttons inside tiles
    document.addEventListener('click', (e) => {
      const stop = e.target.closest('.ap-stop-tile');
      if (!stop) return;

      e.preventDefault();
    }, true); // capture phase so it runs before the other document click handlers


    // Remove owner pill (both modals)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-remove-owner]');
      if (!btn) return;

      const prefix = btn.getAttribute('data-owner-prefix') || 'ep';
      const empId = btn.getAttribute('data-remove-owner');
      if (!empId) return;

      const cur = currentOwners(prefix).filter(x => x.toLowerCase() !== empId.toLowerCase());
      renderOwners(prefix, cur);
    });

    // Tile click => open details modal
document.addEventListener('click', async (e) => {
  // If click started from a button, do nothing here
  if (e.target.closest('.ap-stop-tile')) return;

  const tile = e.target.closest('[data-action="open-details"]');
  if (!tile) return;

  const id = tile.getAttribute('data-id');
  if (!id) return;

  await openActionDetails(id, { focusComments: false });
});


    // Comment button => open details modal and focus comments
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action="comment"]');
      if (!btn) return;

      const id = btn.getAttribute('data-id');
      if (!id) return;

      await openActionDetails(id, { focusComments: true });
    });

    // Post comment button (AJAX)
    $('ad_postCommentBtn')?.addEventListener('click', async () => {
      const actionId = $('ad_actionId')?.value;
      const text = ($('ad_commentText')?.value || '').trim();
      if (!actionId) return;
      if (!text) { $('ad_commentText')?.focus(); return; }

      const btn = $('ad_postCommentBtn');

      try {
        setBtnLoading(btn, true, 'Posting');

        const fd = new FormData();
        fd.append('__RequestVerificationToken', anti());
        fd.append('actionId', actionId);
        fd.append('text', text);

        const res = await fetch('@Url.Action("AddActionComment", "KpiActions")', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        $('ad_commentText').value = '';

        const comments = await getJSON('@Url.Action("GetActionComments", "KpiActions")?actionId=' + encodeURIComponent(actionId));
        if (!comments || comments.length === 0) {
          $('ad_commentsList').innerHTML = `<div class="text-muted small">No comments yet.</div>`;
        } else {
          $('ad_commentsList').innerHTML = comments.map(renderCommentItem).join('');
          $('ad_commentsList')?.lastElementChild?.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
      } catch (err) {
        console.error('[AP] Add comment failed:', err);
        alert('Failed to post comment.');
      } finally {
        setBtnLoading(btn, false);
      }
    });

    /* -------------------------
       Move Deadline
    ------------------------- */
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="move-deadline"]');
      if (!btn || !IS_ADMIN) return;
      $('md_actionId').value = btn.getAttribute('data-id');
      $('md_reason').value = '';
      $('md_due').value = '';
      new bootstrap.Modal(document.getElementById('moveDeadlineModal')).show();
    });

    $('moveDeadlineForm')?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (!IS_ADMIN) return;

      const form = ev.target;

      await withFormLoading(form, async () => {
        const fd = new FormData(form);
        const res = await fetch('@Url.Action("MoveDeadline", "KpiActions")', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        bootstrap.Modal.getInstance(document.getElementById('moveDeadlineModal')).hide();
        await refreshBoard();
      }, 'Saving');
    });

    /* -------------------------
       Edit Action Plan modal
    ------------------------- */
    $('ep_addOwnerBtn')?.addEventListener('click', () => addOwner('ep'));

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action="edit-plan"]');
      if (!btn || !IS_ADMIN) return;

      const id = btn.getAttribute('data-id');
      try {
        const data = await getJSON('@Url.Action("GetAction", "KpiActions")?actionId=' + encodeURIComponent(id));

        $('ep_actionId').value = data.actionId;
        $('ep_desc').value = data.description || '';
        $('ep_status').value = data.statusCode || 'todo';
        $('ep_assignedAt').value = data.assignedAtLocal || '';
        $('ep_due').value = data.dueDateLocal || '';

        renderOwners('ep', data.ownerEmpIds || []);

        new bootstrap.Modal(document.getElementById('editPlanModal')).show();
      } catch (err) {
        console.error('[AP] GetAction failed:', err);
        alert('Failed to load the action.');
      }
    });

    $('editPlanForm')?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (!IS_ADMIN) return;

      const form = ev.target;

      await withFormLoading(form, async () => {
        const fd = new FormData(form);
        if (!fd.get('__RequestVerificationToken')) fd.append('__RequestVerificationToken', anti());

        const res = await fetch('@Url.Action("UpdateAction", "KpiActions")', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        bootstrap.Modal.getInstance(document.getElementById('editPlanModal')).hide();
        await refreshBoard();
      }, 'Saving');
    });

    /* -------------------------
       Archive Action Plan
    ------------------------- */
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="archive-action"]');
      if (!btn || !IS_ADMIN) return;

      const id = btn.getAttribute('data-id');
      if (!id) return;

      $('arc_actionId').value = id;
      new bootstrap.Modal(document.getElementById('archiveModal')).show();
    });

    $('archiveForm')?.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (!IS_ADMIN) return;

      const form = ev.target;

      await withFormLoading(form, async () => {
        const fd = new FormData(form);
        if (!fd.get('__RequestVerificationToken')) fd.append('__RequestVerificationToken', anti());

        const res = await fetch('@Url.Action("ArchiveAction", "KpiActions")', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);

        bootstrap.Modal.getInstance(document.getElementById('archiveModal')).hide();
        await refreshBoard();
      }, 'Archiving');
    });

    /* -------------------------
       Add Action Plan modal (multi-owners)
    ------------------------- */
    $('ap_addOwnerBtn')?.addEventListener('click', () => addOwner('ap'));

    function apApplyGeneralMode(isGeneral) {
      const block = $('ap_kpiBlock');
      const kpiSel = $('ap_kpi');
      if (!block || !kpiSel) return;

      if (isGeneral) {
        block.classList.add('d-none');
        kpiSel.disabled = true;
        kpiSel.required = false;
      } else {
        block.classList.remove('d-none');
        kpiSel.disabled = false;
        kpiSel.required = true;
      }
    }

    async function apLoadPillars() {
      const sel = $('ap_pillar');
      const obj = $('ap_objective');
      const kpi = $('ap_kpi');
      if (!sel || !obj || !kpi) return;

      sel.innerHTML = '<option value="">— Pillar —</option>';
      obj.innerHTML = '<option value="">— Objective —</option>';
      obj.disabled = true;
      kpi.innerHTML = '<option value="">— KPI —</option>';
      kpi.disabled = true;

      try {
        const data = await getJSON('@Url.Action("GetPillars", "Home")');
        (data || []).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error('[AP] GetPillars failed:', err);
      }
    }

    async function apLoadObjectives(pillarId) {
      const obj = $('ap_objective');
      const kpi = $('ap_kpi');
      if (!obj || !kpi) return;

      obj.innerHTML = '<option value="">— Objective —</option>';
      kpi.innerHTML = '<option value="">— KPI —</option>';
      kpi.disabled = true;

      if (!pillarId) {
        obj.disabled = true;
        return;
      }

      try {
        const data = await getJSON('@Url.Action("GetObjectives", "Home")?pillarId=' + encodeURIComponent(pillarId));
        obj.disabled = false;
        (data || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.id;
          opt.textContent = o.name;
          obj.appendChild(opt);
        });
      } catch (err) {
        console.error('[AP] GetObjectives failed:', err);
        obj.disabled = true;
      }
    }

    async function apLoadKpis(objectiveId) {
      const kpi = $('ap_kpi');
      if (!kpi) return;

      kpi.innerHTML = '<option value="">— KPI —</option>';

      if (!objectiveId) {
        kpi.disabled = true;
        return;
      }

      try {
        const data = await getJSON('@Url.Action("GetKpis", "Home")?objectiveId=' + encodeURIComponent(objectiveId));
        kpi.disabled = false;
        (data || []).forEach(k => {
          const opt = document.createElement('option');
          opt.value = k.id;
          opt.textContent = k.name;
          kpi.appendChild(opt);
        });
      } catch (err) {
        console.error('[AP] GetKpis failed:', err);
        kpi.disabled = true;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!IS_ADMIN) return;

      const addBtn = $('apAddBtn');
      const form = $('addPlanForm');
      const chkGeneral = $('ap_isGeneral');
      const selPillar = $('ap_pillar');
      const selObjective = $('ap_objective');

      addBtn?.addEventListener('click', async () => {
        if (!form) return;
        form.reset();

        renderOwners('ap', []);

        if (chkGeneral) chkGeneral.checked = true;
        apApplyGeneralMode(true);
        await apLoadPillars();

        const now = new Date();
        const iso = now.toISOString().slice(0, 16);
        const assigned = $('ap_assignedAt');
        if (assigned && !assigned.value) assigned.value = iso;

        const statusSel = $('ap_status');
        if (statusSel) statusSel.value = 'todo';

        new bootstrap.Modal(document.getElementById('addPlanModal')).show();
      });

      chkGeneral?.addEventListener('change', () => apApplyGeneralMode(chkGeneral.checked));
      selPillar?.addEventListener('change', () => apLoadObjectives(selPillar.value));
      selObjective?.addEventListener('change', () => apLoadKpis(selObjective.value));

      form?.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (!IS_ADMIN) return;

        const formEl = ev.target;

        await withFormLoading(formEl, async () => {
          const isGeneral = chkGeneral && chkGeneral.checked;
          const kpiSel = $('ap_kpi');

          if (!isGeneral && kpiSel && !kpiSel.value) {
            alert('Please select a KPI, or mark the action as General.');
            return;
          }

          const fd = new FormData(formEl);
          if (!fd.get('__RequestVerificationToken')) fd.append('__RequestVerificationToken', anti());

          const url = isGeneral
            ? '@Url.Action("CreateGeneral", "KpiActions")'
            : '@Url.Action("Create", "KpiActions")';

          const res = await fetch(url, {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
          });

          if (!res.ok) throw new Error('HTTP ' + res.status);

          bootstrap.Modal.getInstance(document.getElementById('addPlanModal')).hide();
          await refreshBoard();
        }, 'Adding');
      });
    });
  </script>
}