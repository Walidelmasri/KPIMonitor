@using KPIMonitor.Services
@inject IAdminAuthorizer AdminAuthorizer
@inject IEmployeeDirectory EmpDir
@{
  ViewData["Title"] = "Action Plans";
  var isAdmin = AdminAuthorizer.IsAdmin(User) || AdminAuthorizer.IsSuperAdmin(User);

  // Pull ALL employees once at render (no filtering or preselection)
  // EmployeePickDto => EmpId, Label
  var employees = await EmpDir.GetAllForPickAsync();
}
<style>
  .ap-action-btn {
    min-width: 90px;
    padding: .20rem .45rem;
    font-size: 0.75rem;
    line-height: 1.1;
    white-space: nowrap;
  }
  .ap-colbadge { font-size: 0.95rem; padding: .5rem .75rem; letter-spacing: .1px; }
  .ap-col { display: flex; flex-direction: column; gap: .75rem; }
  .ap-col-header { width: 100%; border-radius: .75rem; padding: .45rem .75rem; font-weight: 700; line-height: 1.2; }
  .ap-col-header--todo  { background: #6c757d; color: #fff; }
  .ap-col-header--prog  { background: #ffc107; color: #000; }
  .ap-col-header--done  { background: #198754; color: #fff; }
  #apBody, #apBody .row, #apBody .col-md-4 { overflow: visible; }
  .ap-scroll { max-height: calc(100vh - 220px); overflow-y: auto; overflow-x: hidden; padding-right: 4px; }
  @@media (min-width: 992px) { .ap-col-header { position: sticky; top: 0; z-index: 5; } }
</style>


<div class="container py-4">
  @section PageHeader {
    <div class="page-hero" style="background-image:url('@Url.Content("~/images/pic1.jpg")')">
      <div class="page-hero-content">
        <h1 class="page-title">Action Plans</h1>
      </div>
    </div>
  }
  <div class="with-rails">
    <!-- hidden antiforgery to reuse in JS -->
    <form id="af" method="post" class="d-none">
      @Html.AntiForgeryToken()
    </form>

    @if (isAdmin)
    {
      <div class="d-flex justify-content-end mb-3">
        <button type="button"
                class="btn btn-sm btn-primary"
                id="apAddBtn">
          + Add action plan
        </button>
      </div>
    }

    <div id="apBody" class="bg-white border rounded-3 p-3">
      <div class="text-muted small">Loading…</div>
    </div>
  </div>
</div>

<!-- Move Deadline Modal -->
<div class="modal fade" id="moveDeadlineModal" tabindex="-1" aria-labelledby="moveDeadlineLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="moveDeadlineLabel">Move Deadline</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="moveDeadlineForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <input type="hidden" name="actionId" id="md_actionId" />
          <div class="mb-3">
            <label class="form-label">New Due Date</label>
            <input type="datetime-local" class="form-control" name="newDueDate" id="md_due" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Reason (optional)</label>
            <textarea class="form-control" name="reason" id="md_reason" rows="2"></textarea>
          </div>
          <div class="text-muted small">Max 3 Extensions.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Move</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Plan Modal -->
<div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="editPlanLabel">Edit Action Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="editPlanForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <input type="hidden" name="actionId" id="ep_actionId" />

          <div class="mb-3">
            <label class="form-label">Owner</label>
            <!-- keep name="owner" so KpiActions.UpdateAction(owner, …) still binds -->
            <select class="form-select" name="owner" id="ep_owner" required>
              <option value="">— Select —</option>
              @foreach (var e in employees ?? Enumerable.Empty<KPIMonitor.ViewModels.EmployeePickDto>())
              {
                  var display = e.Label ?? "";
                  var idx = display.IndexOf('(');
                  if (idx > 0)
                  {
                      display = display.Substring(0, idx).Trim();
                  }
                  // value = full label (includes ID), text = name only
                  <option value="@e.Label">@display</option>
              }

            </select>
            <div class="form-text">Pick a person.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Assigned At</label>
            <input type="datetime-local" class="form-control" name="assignedAt" id="ep_assignedAt" />
          </div>

          <div class="mb-3">
            <label class="form-label">Due Date</label>
            <input type="datetime-local" class="form-control" name="dueDate" id="ep_due" />
          </div>

          <div class="mb-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="statusCode" id="ep_status">
              <option value="todo">To Do</option>
              <option value="inprogress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" id="ep_desc" rows="3" required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>

    </div>
  </div>
</div>
<!-- Archive Action Plan Modal -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="archiveLabel">Archive action plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="archiveForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">
          <input type="hidden" name="actionId" id="arc_actionId" />
          <p class="mb-0">Are you sure you want to archive this action plan?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Archive</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Action Plan Modal -->
<div class="modal fade" id="addPlanModal" tabindex="-1" aria-labelledby="addPlanLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="addPlanLabel">Add Action Plan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="addPlanForm" method="post">
        @Html.AntiForgeryToken()
        <div class="modal-body">

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="ap_isGeneral" checked>
            <label class="form-check-label" for="ap_isGeneral">
              General action (not tied to a KPI)
            </label>
          </div>

          <div class="mb-3" id="ap_kpiBlock">
            <label class="form-label">Link to KPI</label>
            <div class="row g-2">
              <div class="col-md-4">
                <select class="form-select" id="ap_pillar">
                  <option value="">— Pillar —</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select" id="ap_objective" disabled>
                  <option value="">— Objective —</option>
                </select>
              </div>
              <div class="col-md-4">
                <!-- name="KpiId" so it binds to KpiAction.KpiId in Create(...) -->
                <select class="form-select" id="ap_kpi" name="KpiId" disabled>
                  <option value="">— KPI —</option>
                </select>
              </div>
            </div>
            <div class="form-text">
              Leave as <em>General</em> above if this action is not for a specific KPI.
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Owner</label>
            <!-- name="Owner" so it binds to KpiAction.Owner in Create/CreateGeneral -->
            <select class="form-select" name="Owner" id="ap_owner" required>
              <option value="">— Select —</option>
              @foreach (var e in employees ?? Enumerable.Empty<KPIMonitor.ViewModels.EmployeePickDto>())
              {
                  var display = e.Label ?? "";
                  var idx = display.IndexOf('(');
                  if (idx > 0)
                  {
                      display = display.Substring(0, idx).Trim();
                  }
                  <option value="@e.Label">@display</option>
              }

            </select>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Assigned at</label>
              <input type="datetime-local" class="form-control" name="AssignedAt" id="ap_assignedAt" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Due date</label>
              <input type="datetime-local" class="form-control" name="DueDate" id="ap_due" />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Status</label>
            <!-- name="StatusCode" so it binds directly to KpiAction.StatusCode -->
            <select class="form-select" name="StatusCode" id="ap_status">
              <option value="todo">To Do</option>
              <option value="inprogress">In Progress</option>
              <option value="done">Done</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="Description" id="ap_desc" rows="3" required></textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
  <script>
    const IS_ADMIN = @(isAdmin ? "true" : "false");
    const $  = (id) => document.getElementById(id);
    const qs = (sel, root = document) => root.querySelector(sel);
    const anti = () => (qs('input[name="__RequestVerificationToken"]')?.value || '');
    const getJSON = (url) => fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });

    let apKpiIds = [];

    function stripAdminControls(){
      if (IS_ADMIN) return;
      const root = $('apBody');
      if (!root) return;

      const selectors = [
        '[data-action="move-deadline"]',
        '[data-action="edit-plan"]',
        '[data-action="delete-action"]',
        '[data-action="close-action"]',
        '[data-admin-only]',
        '[asp-admin-only]'
      ];
      selectors.forEach(sel => { root.querySelectorAll(sel).forEach(n => n.remove()); });

      root.querySelectorAll('.btn-group, .ap-actions, .card-actions').forEach(group => {
        const hasVisibleChild = Array.from(group.children).some(ch => !!(ch.offsetParent));
        if (!hasVisibleChild || group.children.length === 0) group.remove();
      });
    }
    async function refreshBoard() {
      try {
        // No KPI filter on this page: show all KPI-linked actions.
        const res = await fetch('@Url.Action("BoardHtml", "ActionPlans")', {
          method: 'POST',
          headers: {
            'Accept': 'text/html',
            'Content-Type': 'application/json',
            'RequestVerificationToken': anti()
          },
          body: JSON.stringify(apKpiIds) // will be an empty array, meaning "no filter"
        });

        if (!res.ok) throw new Error('HTTP ' + res.status);
        $('apBody').innerHTML = "<div class='ap-scroll'>" + (await res.text()) + "</div>";
        stripAdminControls();
      } catch (err) {
        console.error('[AP] BoardHtml failed:', err);
        $('apBody').innerHTML = "<div class='text-danger small'>Failed to load actions.</div>";
      }
    }

    document.addEventListener('DOMContentLoaded', refreshBoard);

    // Move Deadline — open
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="move-deadline"]');
      if (!btn || !IS_ADMIN) return;
      $('md_actionId').value = btn.getAttribute('data-id');
      $('md_reason').value = '';
      $('md_due').value = '';
      new bootstrap.Modal(document.getElementById('moveDeadlineModal')).show();
    });

    // Move Deadline — submit
    document.getElementById('moveDeadlineForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (!IS_ADMIN) return;
      try {
        const fd = new FormData(ev.target);
        const res = await fetch('@Url.Action("MoveDeadline", "KpiActions")', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        bootstrap.Modal.getInstance(document.getElementById('moveDeadlineModal')).hide();
        await refreshBoard();
      } catch (err) {
        console.error('[AP] MoveDeadline failed:', err);
        alert('Failed to move deadline (check max 3 extensions).');
      }
    });

    // Edit Plan — open (uses the pre-rendered full Owner dropdown)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action="edit-plan"]');
      if (!btn || !IS_ADMIN) return;

      const id = btn.getAttribute('data-id');
      try {
        const data = await getJSON('@Url.Action("GetAction", "KpiActions")?actionId=' + encodeURIComponent(id));

        $('ep_actionId').value   = data.actionId;
        $('ep_desc').value       = data.description || '';
        $('ep_status').value     = data.statusCode || 'todo';
        $('ep_assignedAt').value = data.assignedAtLocal || '';
        $('ep_due').value        = data.dueDateLocal || '';

        const ownerSel = $('ep_owner');
        if (ownerSel) {
          // Pre-select existing owner if we have one and it matches an option
          ownerSel.value = data.owner || '';
          if (!ownerSel.value && data.owner) {
            // Fallback: if label changed, try to find option whose value starts with the same name prefix
            const opts = Array.from(ownerSel.options);
            const match = opts.find(o => (o.value || '').startsWith(data.owner));
            if (match) ownerSel.value = match.value;
          }
        }


        new bootstrap.Modal(document.getElementById('editPlanModal')).show();
      } catch (err) {
        console.error('[AP] GetAction failed:', err);
        alert('Failed to load the action.');
      }
    });

    // Edit Plan — submit
    document.getElementById('editPlanForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      if (!IS_ADMIN) return;
      try {
        const fd = new FormData(ev.target);
        if (!fd.get('__RequestVerificationToken')) fd.append('__RequestVerificationToken', anti());
        const res = await fetch('@Url.Action("UpdateAction", "KpiActions")', {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        bootstrap.Modal.getInstance(document.getElementById('editPlanModal')).hide();
        await refreshBoard();
      } catch (err) {
        console.error('[AP] UpdateAction failed:', err);
        alert('Save failed.');
      }
    });
    // Archive Action Plan — open confirm modal
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="archive-action"]');
      if (!btn || !IS_ADMIN) return;

      const id = btn.getAttribute('data-id');
      if (!id) return;

      $('arc_actionId').value = id;
      new bootstrap.Modal(document.getElementById('archiveModal')).show();
    });
    // Archive Action Plan — submit
    const archiveForm = document.getElementById('archiveForm');
    if (archiveForm) {
      archiveForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (!IS_ADMIN) return;

        try {
          const fd = new FormData(archiveForm);
          if (!fd.get('__RequestVerificationToken')) {
            fd.append('__RequestVerificationToken', anti());
          }

          const res = await fetch('@Url.Action("ArchiveAction", "KpiActions")', {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
          });

          if (!res.ok) throw new Error('HTTP ' + res.status);

          bootstrap.Modal.getInstance(document.getElementById('archiveModal')).hide();
          await refreshBoard();
        } catch (err) {
          console.error('[AP] ArchiveAction failed:', err);
          alert('Failed to archive action plan.');
        }
      });
    }

    // -------------------------
    // Add Action Plan helpers
    // -------------------------
    function apApplyGeneralMode(isGeneral) {
      const block = document.getElementById('ap_kpiBlock');
      const kpiSel = document.getElementById('ap_kpi');
      if (!block || !kpiSel) return;

      if (isGeneral) {
        block.classList.add('d-none');
        kpiSel.disabled = true;
        kpiSel.required = false;
      } else {
        block.classList.remove('d-none');
        kpiSel.disabled = false;
        kpiSel.required = true;
      }
    }

    async function apLoadPillars() {
      const sel = document.getElementById('ap_pillar');
      const obj = document.getElementById('ap_objective');
      const kpi = document.getElementById('ap_kpi');
      if (!sel || !obj || !kpi) return;

      sel.innerHTML = '<option value="">— Pillar —</option>';
      obj.innerHTML = '<option value="">— Objective —</option>';
      obj.disabled = true;
      kpi.innerHTML = '<option value="">— KPI —</option>';
      kpi.disabled = true;

      try {
        const data = await getJSON('@Url.Action("GetPillars", "Home")');
        (data || []).forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error('[AP] GetPillars failed:', err);
      }
    }

    async function apLoadObjectives(pillarId) {
      const obj = document.getElementById('ap_objective');
      const kpi = document.getElementById('ap_kpi');
      if (!obj || !kpi) return;

      obj.innerHTML = '<option value="">— Objective —</option>';
      kpi.innerHTML = '<option value="">— KPI —</option>';
      kpi.disabled = true;

      if (!pillarId) {
        obj.disabled = true;
        return;
      }

      try {
        const data = await getJSON('@Url.Action("GetObjectives", "Home")?pillarId=' + encodeURIComponent(pillarId));
        obj.disabled = false;
        (data || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.id;
          opt.textContent = o.name;
          obj.appendChild(opt);
        });
      } catch (err) {
        console.error('[AP] GetObjectives failed:', err);
        obj.disabled = true;
      }
    }

    async function apLoadKpis(objectiveId) {
      const kpi = document.getElementById('ap_kpi');
      if (!kpi) return;

      kpi.innerHTML = '<option value="">— KPI —</option>';

      if (!objectiveId) {
        kpi.disabled = true;
        return;
      }

      try {
        const data = await getJSON('@Url.Action("GetKpis", "Home")?objectiveId=' + encodeURIComponent(objectiveId));
        kpi.disabled = false;
        (data || []).forEach(k => {
          const opt = document.createElement('option');
          opt.value = k.id;
          opt.textContent = k.name;
          kpi.appendChild(opt);
        });
      } catch (err) {
        console.error('[AP] GetKpis failed:', err);
        kpi.disabled = true;
      }
    }

    // Wire up Add button + modal
    document.addEventListener('DOMContentLoaded', () => {
      if (!IS_ADMIN) return;

      const addBtn = document.getElementById('apAddBtn');
      const form = document.getElementById('addPlanForm');
      const chkGeneral = document.getElementById('ap_isGeneral');
      const selPillar = document.getElementById('ap_pillar');
      const selObjective = document.getElementById('ap_objective');

      if (addBtn) {
        addBtn.addEventListener('click', async () => {
          if (!form) return;
          form.reset();

          if (chkGeneral) chkGeneral.checked = true;
          apApplyGeneralMode(true);
          await apLoadPillars();

          const now = new Date();
          const iso = now.toISOString().slice(0, 16); // yyyy-MM-ddTHH:mm
          const assigned = document.getElementById('ap_assignedAt');
          if (assigned && !assigned.value) assigned.value = iso;

          const statusSel = document.getElementById('ap_status');
          if (statusSel) statusSel.value = 'todo';

          new bootstrap.Modal(document.getElementById('addPlanModal')).show();
        });
      }

      if (chkGeneral) {
        chkGeneral.addEventListener('change', () => {
          apApplyGeneralMode(chkGeneral.checked);
        });
      }

      if (selPillar) {
        selPillar.addEventListener('change', () => {
          apLoadObjectives(selPillar.value);
        });
      }

      if (selObjective) {
        selObjective.addEventListener('change', () => {
          apLoadKpis(selObjective.value);
        });
      }

      if (form) {
        form.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          if (!IS_ADMIN) return;

          const isGeneral = chkGeneral && chkGeneral.checked;
          const kpiSel = document.getElementById('ap_kpi');

          if (!isGeneral && kpiSel && !kpiSel.value) {
            alert('Please select a KPI, or mark the action as General.');
            return;
          }

          try {
            const fd = new FormData(form);
            if (!fd.get('__RequestVerificationToken')) {
              fd.append('__RequestVerificationToken', anti());
            }

            const url = isGeneral
              ? '@Url.Action("CreateGeneral", "KpiActions")'
              : '@Url.Action("Create", "KpiActions")';

            const res = await fetch(url, {
              method: 'POST',
              body: fd,
              headers: {
                'Accept': 'text/html',
                'X-Requested-With': 'XMLHttpRequest'
              }
            });

            if (!res.ok) throw new Error('HTTP ' + res.status);

            bootstrap.Modal.getInstance(document.getElementById('addPlanModal')).hide();
            await refreshBoard();
          } catch (err) {
            console.error('[AP] Create action failed:', err);
            alert('Failed to create action plan.');
          }
        });
      }
    });
  </script>
}
