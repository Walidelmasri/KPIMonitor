@using KPIMonitor.Services
@inject IAdminAuthorizer AdminAuthorizer
@inject IEmployeeDirectory EmpDir
@{
    ViewData["Title"] = "RedBoard";
    var isAdmin = AdminAuthorizer.IsAdmin(User) || AdminAuthorizer.IsSuperAdmin(User);

    // EmployeePickDto => EmpId, Label (same as ActionPlans page)
    var employees = await EmpDir.GetAllForPickAsync();
}

<style>
    /* subtle alert tint for RedBoard */
    .alert-tint {
        background: #fff5f5 !important;
        border-color: #f8d7da !important;
        box-shadow: 0 2px 8px rgba(220, 53, 69, .10) !important;
    }

    .alert-tint .card-title,
    .alert-tint h6 {
        color: #842029;
    }

    #redCountBadge {
        font-weight: 700;
        font-size: 0.95rem;
    }

    .arrange-modal-dialog {
        max-width: 1200px;
        width: 95vw;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        // ---------------------------
        // Admin flag + Helpers
        // ---------------------------
        const IS_ADMIN = @(isAdmin ? "true" : "false");
        const $ = (id) => document.getElementById(id);
        const qs = (sel, root = document) => root.querySelector(sel);
        const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));
        const ENABLE_DECISIONS = false; // <- turn off the last slide safely

        // === UI status name mapper (code or label in, pretty label out) ===
        function uiStatus(codeOrLabel) {
            const s = String(codeOrLabel || '').trim().toLowerCase();
            switch (s) {
                case 'green':
                case 'conforme':
                case 'ok':
                    return 'Target Achieved';
                case 'orange':
                case 'rattrapage':
                case 'catching up':
                    return 'On Forecast';
                case 'red':
                case 'ecart':
                case 'needs attention':
                    return 'Target Missed';
                case 'blue':
                case 'attente':
                case 'data missing':
                    return 'Data Missing (No Changes)';
                default:
                    return '—';
            }
        }

        // Antiforgery token (we render it below in a hidden form)
        const anti = () => (qs('input[name="__RequestVerificationToken"]')?.value || '');

        // Simple GET (expects JSON)
        const getJSON = (url) => fetch(url, { headers: { 'Accept': 'application/json' } }).then(r => r.json());

        // Simple GET (expects HTML)
        const getHTML = (url) => fetch(url, { headers: { 'Accept': 'text/html' } }).then(r => r.text());

        // Simple POST (form submit via fetch, following redirects)
        async function postForm(url, form) {
            const fd = new FormData(form);
            if (!fd.get('__RequestVerificationToken')) fd.append('__RequestVerificationToken', anti());
            const res = await fetch(url, {
                method: 'POST',
                body: fd,
                headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!res.ok) throw new Error('Save failed');
            return res.text();
        }

        // Strip/disable admin-only controls inside injected actions HTML
        function stripAdminControlsInActions() {
            if (IS_ADMIN) return;
            const root = $('actionsList');
            if (!root) return;

            ['[data-action="move-deadline"]',
                '[data-action="delete-action"]',
                '[data-action="close-action"]',
                '[data-action="edit-action"]',
                '[data-admin-only]',
                '[asp-admin-only]'].forEach(sel => {
                    root.querySelectorAll(sel).forEach(n => n.remove());
                });

            root.querySelectorAll('select[data-action="set-status"]').forEach(sel => {
                sel.disabled = true;
                sel.classList.add('disabled');
                sel.title = 'Admins only';
            });

            root.querySelectorAll('.btn-group, .ap-actions, .card-actions').forEach(group => {
                if (!group.querySelector('button, a, select')) group.remove();
            });
        }

        // ---------------------------
        // Slide deck state
        // ---------------------------
        let redList = [];   // [{kpiId, name, code, priority, sortOrder, isHidden}]
        let deck = [];      // sequence of slides: kpi slides (+ decisions if enabled)
        let idx = 0;
        let kpiChart;
        let currentKpiId = null;
        let runKpiIds = [];

        function _fmtShort(v) {
            const n = Number(v);
            if (!isFinite(n)) return '';
            // full number, with thousands separators (e.g. 1,234,567)
            return n.toLocaleString();
        }


        // === SmartValueLabels plugin ===
        const SmartValueLabels = {
            id: 'smartValueLabels',
            afterDatasetsDraw(chart, _args, opts) {
                const { ctx, data, chartArea } = chart;
                const o = opts || {};
                const fmt = typeof o.formatter === 'function' ? o.formatter : (v) => String(v);
                const fontSize = o.fontSize || 12;
                const fontWeight = o.fontWeight || '700';
                const minGap = o.minGap || 14;
                const padTop = o.padTop || 4;
                const padBottom = o.padBottom || 4;
                const maxShift = o.maxShift || 40;
                const barDY = (o.barDY != null ? o.barDY : -12);
                const barDYNeg = (o.barDYNeg != null ? o.barDYNeg : 14);
                const lineDY = (o.lineDY != null ? o.lineDY : -12);
                const perDataset = o.perDataset || [];
                const lineStepDefault = o.lineStep || 1;
                const onlyLastForLinesDefault = !!o.onlyLastForLines;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.font = `${fontWeight} ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;

                const byIndex = new Map();
                data.datasets.forEach((ds, di) => {
                    if (!chart.isDatasetVisible(di)) return;
                    const meta = chart.getDatasetMeta(di);
                    const type = ds.type || meta.type;
                    const isBar = type === 'bar';
                    const isLine = type === 'line';
                    const per = perDataset[di] || {};
                    const step = Number.isInteger(per.step) ? Math.max(1, per.step) : lineStepDefault;

                    let lastIdxForThisLine = null;
                    if (isLine && (onlyLastForLinesDefault || per.onlyLast)) {
                        for (let i = ds.data.length - 1; i >= 0; i--) {
                            const v = ds.data[i];
                            if (v != null && !Number.isNaN(+v)) { lastIdxForThisLine = i; break; }
                        }
                    }

                    meta.data.forEach((el, i) => {
                        const raw = ds.data[i];
                        const val = Number(raw);
                        if (raw == null || Number.isNaN(val)) return;

                        if (isLine) {
                            if ((onlyLastForLinesDefault || per.onlyLast) && i !== lastIdxForThisLine) return;
                            if ((i % step) !== 0) return;
                        }

                        const { x, y } = el.getProps(['x', 'y'], true);
                        let dy = isBar ? (val < 0 ? barDYNeg : barDY) : lineDY;
                        if (typeof per.dy === 'number') dy = per.dy;
                        const dx = (typeof per.dx === 'number') ? per.dx : 0;

                        const text = fmt(val);
                        const w = ctx.measureText(text).width;
                        const h = fontSize * 1.2;

                        const item = {
                            x: x + dx, y: y + dy, baseY: y + dy,
                            val, text, color: per.color || o.color || '#111',
                            w, h, priority: isBar ? 0 : 1
                        };
                        const arr = byIndex.get(i);
                        if (arr) arr.push(item); else byIndex.set(i, [item]);
                    });
                });

                const topLimitBase = chartArea.top + padTop;
                const botLimit = chartArea.bottom - padBottom;

                byIndex.forEach((items) => {
                    const clamp = (it) => {
                        const topLimit = topLimitBase + it.h;
                        if (it.y < topLimit) it.y = topLimit;
                        const low = it.baseY - maxShift;
                        const high = it.baseY + maxShift;
                        if (it.y < low) it.y = low;
                        if (it.y > high) it.y = high;
                        if (it.y > botLimit) it.y = botLimit;
                    };
                    items.forEach(it => { it.y = it.baseY; clamp(it); });

                    let guard = 0;
                    while (guard++ < 10) {
                        let changed = false;
                        for (let i = 0; i < items.length; i++) {
                            for (let j = i + 1; j < items.length; j++) {
                                const a = items[i], b = items[j];
                                const aL = a.x - a.w / 2, aR = a.x + a.w / 2, aT = a.y - a.h, aB = a.y;
                                const bL = b.x - b.w / 2, bR = b.x + b.w / 2, bT = b.y - b.h, bB = b.y;
                                const overlap = !(aR < bL || aL > bR || aB < bT || aT > bB);
                                if (overlap) {
                                    const hi = (a.val >= b.val) ? a : b;
                                    const lo = (hi === a) ? b : a;
                                    hi.y -= minGap;
                                    lo.y += Math.min(4, minGap / 2);
                                    clamp(hi); clamp(lo);
                                    changed = true;
                                }
                            }
                        }
                        if (!changed) break;
                    }

                    items.sort((a, b) => a.priority - b.priority);
                    const { ctx } = chart;
                    items.forEach(it => {
                        ctx.fillStyle = it.color;
                        if (o.outline) { ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(255,255,255,0.95)'; ctx.strokeText(it.text, it.x, it.y); }
                        ctx.fillText(it.text, it.x, it.y);
                    });
                });

                ctx.restore();
            }
        };
        Chart.register(SmartValueLabels);
        Chart.register(ChartDataLabels);

        // ---------------------------
        // Load red list + build deck (ORDER + HIDDEN COME FROM BACKEND)
        // ---------------------------
        async function loadRedList() {
            redList = await getJSON('@Url.Action("GetRedKpiIds", "RedBoard")');

            const badge = $('redCountBadge');
            if (badge) {
                const n = Array.isArray(redList) ? redList.length : 0;
                badge.textContent = `${n} KPI${n === 1 ? '' : 's'} need attention`;
                badge.classList.toggle('d-none', n === 0);
            }

            if (!redList || redList.length === 0) {
                $('emptyMsg').classList.remove('d-none');
                $('slideWrap').classList.add('d-none');
                deck = [];
                runKpiIds = [];
                idx = 0;
                return;
            }

            $('emptyMsg').classList.add('d-none');
            $('slideWrap').classList.remove('d-none');

            deck = [];
            runKpiIds = [];

            // Only non-hidden KPIs go into slideshow deck
            for (const k of redList) {
                if (k.isHidden) continue;
                deck.push({ type: 'kpi', ...k });
                runKpiIds.push(k.kpiId);
            }

            if (ENABLE_DECISIONS && runKpiIds.length > 0) {
                deck.push({ type: 'decisions' });
            }

            idx = 0;
            await showCurrent();
        }

        // ---------------------------
        // Show current slide 
        // ---------------------------
        async function showCurrent() {
            if (!deck.length) {
                $('slideCounter').innerText = '0 / 0';
                $('titleSlide').classList.add('d-none');
                $('kpiSlide').classList.add('d-none');
                $('actionsBlock').classList.add('d-none');
                $('decisionsWrap').classList.add('d-none');
                return;
            }

            const slide = deck[idx];
            $('slideCounter').innerText = `${idx + 1} / ${deck.length}`;
            $('decisionsWrap').classList.add('d-none');

            const isLast = (idx === deck.length - 1);
            const isFirst = (idx === 0);
            $('btnFirst') && ($('btnFirst').disabled = isFirst);
            $('btnLast') && ($('btnLast').disabled = isLast);

            if (slide.type === 'decisions' && ENABLE_DECISIONS) {
                $('titleSlide').classList.add('d-none');
                $('kpiSlide').classList.add('d-none');
                $('actionsBlock').classList.add('d-none');
                await showDecisions();
                return;
            }

            $('titleSlide').classList.add('d-none');
            $('kpiSlide').classList.remove('d-none');
            $('actionsBlock').classList.remove('d-none');

            currentKpiId = slide.kpiId;
            $('kpiHeading').innerText = `KPI Name: ${slide.name}`;
            $('kpiSub').innerText = `${slide.code}`;

            const addBtn = $('btnAddAction');
            if (addBtn) {
                addBtn.disabled = !IS_ADMIN;
                addBtn.classList.toggle('d-none', !IS_ADMIN);
            }

            const data = await getJSON('@Url.Action("GetKpiPresentation", "RedBoard")?kpiId=' + slide.kpiId);
            $('m_title').innerText = data?.meta?.title ?? '—';
            // Extract only the KPI code from slide.code
            let cleanCode = "—";
            if (slide.code) {
                const match = slide.code.match(/KPI Code:\s*(.*)/);
                if (match && match[1]) cleanCode = match[1].trim();
            }

            $('m_code').innerText = cleanCode;
            $('m_owner').innerText = data?.meta?.owner ?? '—';
            $('m_editor').innerText = data?.meta?.editor ?? '—';
            $('m_frequency').innerText = data?.meta?.valueType ?? '—';
            $('m_unit').innerText = data?.meta?.unit ?? '—';
            $('m_priority').innerText = data?.meta?.priority ?? '—';
            const status = $('m_status');
            status.innerText = uiStatus(data?.meta?.statusLabel);
            status.style.background = data?.meta?.statusColor ?? '';
            status.className = 'status-pill';

            const baseLabels = data?.chart?.labels || [];
            const act = data?.chart?.actual || [];
            const tgt = data?.chart?.target || [];
            const fct = data?.chart?.forecast || [];
            const yrs = Array.isArray(data?.chart?.yearTargets) ? data.chart.yearTargets : [];
            const yearLabels = yrs.map(y => String(y.year));
            const yearVals = yrs.map(y => y.value ?? null);
            const allLabels = baseLabels.concat(yearLabels);
            const pad = new Array(yearLabels.length).fill(null);
            const leftNulls = new Array(baseLabels.length).fill(null);

            const chartData = {
                labels: allLabels,
                datasets: [
                    {
                        type: 'bar',
                        label: 'Actual',
                        data: act.concat(pad),
                        backgroundColor: '#800080',
                        borderColor: '#800080',
                        borderWidth: 2,
                        borderSkipped: 'bottom'
                    },
                    {
                        type: 'line',
                        label: 'Target',
                        data: tgt.concat(pad),
                        borderColor: '#7a7a7a',
                        pointBackgroundColor: '#7a7a7a',
                        pointBorderColor: '#7a7a7a',
                        borderWidth: 2,
                        tension: .3,
                        fill: false
                    },
                    {
                        type: 'line',
                        label: 'Forecast',
                        data: fct.concat(pad),
                        borderColor: '#fd7e14',
                        pointBackgroundColor: '#fd7e14',
                        pointBorderColor: '#fd7e14',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        tension: .3,
                        fill: false
                    },
                    {
                        type: 'bar',
                        label: 'Year Target',
                        data: leftNulls.concat(yearVals),
                        backgroundColor: '#7a7a7a',
                        borderColor: '#7a7a7a',
                        borderWidth: 1
                    }
                ]
            };

            if (!kpiChart) {
                kpiChart = new Chart($('rbChart').getContext('2d'), {
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: { padding: { top: 28, bottom: 8 } },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    padding: 8,
                                    callback: function (v) {
                                        return String(this.getLabelForValue(v)).replace(/^\s*\d{4}\s*[\-–—]\s*/, '');
                                    }
                                }
                            },
                            y: { display: false, grid: { display: false }, beginAtZero: true }
                        },
                        plugins: {
                            datalabels: false,
                            smartValueLabels: {
                                formatter: _fmtShort,
                                fontSize: 16,
                                fontWeight: '700',
                                minGap: 14,
                                padTop: 12,
                                padBottom: 4,
                                outline: true,
                                perDataset: [
                                    { dy: -12, dx: 0, color: '#800080' },
                                    { dy: 12, dx: -8, color: '#7a7a7a' },
                                    { dy: -16, dx: 8, color: '#fd7e14' },
                                    { dy: -12, dx: 0, color: '#7a7a7a' }
                                ]
                            },
                            tooltip: { enabled: true },
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    boxHeight: 10,
                                    padding: 12,
                                    font: { size: 8, weight: '700' }
                                }
                            }
                        }
                    }
                });
            } else {
                kpiChart.data = chartData;
                kpiChart.update();
            }

            await loadActionsHtml(slide.kpiId);
        }

        window.prevSlide = async () => {
            if (!deck.length) return;
            idx = (idx - 1 + deck.length) % deck.length;
            await showCurrent();
        };
        window.nextSlide = async () => {
            if (!deck.length) return;
            idx = (idx + 1) % deck.length;
            await showCurrent();
        };
        window.firstSlide = async () => {
            if (!deck.length) return;
            idx = 0;
            await showCurrent();
        };
        window.lastSlide = async () => {
            if (!deck.length) return;
            idx = deck.length - 1;
            await showCurrent();
        };

        // ---------------------------
        // Actions Block (HTML fetch)
        // ---------------------------
        async function loadActionsHtml(kpiId) {
            $('actionsList').innerHTML = "<div class='text-muted small'>Loading…</div>";
            try {
                const html = await getHTML('@Url.Action("ActionsListHtml", "RedBoard")?kpiId=' + encodeURIComponent(kpiId));
                $('actionsList').innerHTML = html;
                stripAdminControlsInActions();
            } catch {
                $('actionsList').innerHTML = "<div class='text-danger small'>Failed to load actions.</div>";
            }
        }

        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-action]');
            if (!btn) return;

            const act = btn.getAttribute('data-action');
            if (act === 'move-deadline') {
                if (!IS_ADMIN) return;
                const id = btn.getAttribute('data-id');
                openMoveDeadline(id);
            }
        });

        document.addEventListener('change', async (e) => {
            const sel = e.target.closest('select[data-action="set-status"]');
            if (!sel) return;
            if (!IS_ADMIN) {
                sel.value = sel.getAttribute('data-current') || sel.value;
                return;
            }
            const id = sel.getAttribute('data-id');
            const val = sel.value;
            try {
                const form = new FormData();
                form.append('__RequestVerificationToken', anti());
                form.append('actionId', id);
                form.append('statusCode', val);
                const res = await fetch('@Url.Action("SetStatus", "KpiActions")', {
                    method: 'POST',
                    body: form,
                    headers: { 'Accept': 'text/html', 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) throw 0;
                await loadActionsHtml(currentKpiId);
            } catch { alert('Failed to update status.'); }
        });

        // ---------------------------
        // Add Action Modal (admin only)
        // ---------------------------
        function openAddAction() {
            if (!IS_ADMIN) return;
            if (!currentKpiId) return;
            $('af_kpiId').value = currentKpiId;
            $('af_owner').value = '';
            $('af_description').value = '';
            $('af_due').value = '';
            $('af_status').value = 'todo';
            const m = new bootstrap.Modal(document.getElementById('addActionModal'));
            m.show();
        }

        async function submitAddAction(ev) {
            ev.preventDefault();
            if (!IS_ADMIN) return;
            try {
                const url = isGeneralCreate
                    ? '@Url.Action("CreateGeneral", "KpiActions")'
                    : '@Url.Action("Create", "KpiActions")';

                await postForm(url, $('addActionForm'));
                bootstrap.Modal.getInstance(document.getElementById('addActionModal')).hide();
                isGeneralCreate = false;
                await loadActionsHtml(currentKpiId);
            } catch {
                alert('Save failed.');
            }
        }

        // ---------------------------
        // Move Deadline Modal (admin only)
        // ---------------------------
        function openMoveDeadline(actionId) {
            if (!IS_ADMIN) return;
            $('md_actionId').value = actionId;
            $('md_reason').value = '';
            $('md_due').value = '';
            const m = new bootstrap.Modal(document.getElementById('moveDeadlineModal'));
            m.show();
        }

        async function submitMoveDeadline(ev) {
            ev.preventDefault();
            if (!IS_ADMIN) return;
            try {
                await postForm('@Url.Action("MoveDeadline", "KpiActions")', $('moveDeadlineForm'));
                bootstrap.Modal.getInstance(document.getElementById('moveDeadlineModal')).hide();
                await loadActionsHtml(currentKpiId);
            } catch {
                alert('Failed to move deadline (check max 3 extensions).');
            }
        }

        // ---------------------------
        // Decisions Board (HTML fetch) + Add General Action (admin only)
        // ---------------------------
        async function showDecisions() {
            if (!runKpiIds.length) return;
            $('decisionsWrap').classList.remove('d-none');
            $('decisionsBody').innerHTML = "<div class='text-muted small'>Loading…</div>";
            try {
                const res = await fetch('@Url.Action("DecisionsBoardHtml", "RedBoard")', {
                    method: 'POST',
                    headers: {
                        'Accept': 'text/html',
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': anti()
                    },
                    body: JSON.stringify(runKpiIds)
                });
                if (!res.ok) throw 0;
                $('decisionsBody').innerHTML = await res.text();
                $('decisionsWrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
                stripAdminControlsInActions();
            } catch {
                $('decisionsBody').innerHTML = "<div class='text-danger small'>Failed to load decisions.</div>";
            }
        }

        // ---------------------------
        // ARRANGE INDICATORS (3 lists: Hidden, Available, Slideshow)
        // ---------------------------
        let arrangeModalInstance = null;

        function findKpiById(id) {
            const numId = Number(id);
            return redList.find(k => Number(k.kpiId) === numId);
        }

        function createSelectedLi(kpi) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.dataset.kpiId = kpi.kpiId;

            const info = document.createElement('div');
            info.className = 'me-2';
            const title = document.createElement('div');
            title.className = 'fw-semibold';
            title.textContent = kpi.name || '—';
            const sub = document.createElement('div');
            sub.className = 'small text-muted';
            sub.textContent = kpi.code || '';
            info.appendChild(title);
            info.appendChild(sub);

            const btns = document.createElement('div');
            btns.className = 'btn-group btn-group-sm';
            btns.innerHTML = `
                                            <button type="button" class="btn btn-outline-secondary" onclick="moveArrangeUp(this)">↑</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="moveArrangeDown(this)">↓</button>
                                            <button type="button" class="btn btn-outline-danger" onclick="removeFromSelected(this)">✕</button>
                                            <button type="button" class="btn btn-outline-warning" onclick="hideFromSelected(this)">Hide</button>
                                        `;

            li.appendChild(info);
            li.appendChild(btns);
            return li;
        }

        function createAvailableLi(kpi) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.dataset.kpiId = kpi.kpiId;

            const info = document.createElement('div');
            info.className = 'me-2';
            const title = document.createElement('div');
            title.className = 'fw-semibold';
            title.textContent = kpi.name || '—';
            const sub = document.createElement('div');
            sub.className = 'small text-muted';
            sub.textContent = kpi.code || '';
            info.appendChild(title);
            info.appendChild(sub);

            const btns = document.createElement('div');
            btns.className = 'btn-group btn-group-sm';
            btns.innerHTML = `
                                            <button type="button" class="btn btn-outline-primary" onclick="addToSelected(this)">Add</button>
                                            <button type="button" class="btn btn-outline-warning" onclick="hideFromAvailable(this)">Hide</button>
                                        `;

            li.appendChild(info);
            li.appendChild(btns);
            return li;
        }

        function createHiddenLi(kpi) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.dataset.kpiId = kpi.kpiId;

            const info = document.createElement('div');
            info.className = 'me-2';
            const title = document.createElement('div');
            title.className = 'fw-semibold text-muted';
            title.textContent = kpi.name || '—';
            const sub = document.createElement('div');
            sub.className = 'small text-muted';
            sub.textContent = kpi.code || '';
            info.appendChild(title);
            info.appendChild(sub);

            const btns = document.createElement('div');
            btns.className = 'btn-group btn-group-sm';
            btns.innerHTML = `
                                            <button type="button" class="btn btn-outline-success" onclick="unhideIndicator(this)">Unhide</button>
                                        `;

            li.appendChild(info);
            li.appendChild(btns);
            return li;
        }

        function moveArrangeUp(btn) {
            const li = btn.closest('li');
            const list = li.parentElement;
            const prev = li.previousElementSibling;
            if (prev) list.insertBefore(li, prev);
        }

        function moveArrangeDown(btn) {
            const li = btn.closest('li');
            const list = li.parentElement;
            const next = li.nextElementSibling;
            if (next) list.insertBefore(next, li);
        }

        function removeFromSelected(btn) {
            const li = btn.closest('li');
            const kpi = findKpiById(li.dataset.kpiId);
            if (!kpi) { li.remove(); return; }
            const avail = $('arrangeAvailableList');
            avail.appendChild(createAvailableLi(kpi));
            li.remove();
        }

        function addToSelected(btn) {
            const li = btn.closest('li');
            const kpi = findKpiById(li.dataset.kpiId);
            if (!kpi) { li.remove(); return; }
            const selected = $('arrangeSelectedList');
            selected.appendChild(createSelectedLi(kpi));
            li.remove();
        }

        function hideFromSelected(btn) {
            const li = btn.closest('li');
            const kpi = findKpiById(li.dataset.kpiId);
            if (!kpi) { li.remove(); return; }
            const hidden = $('arrangeHiddenList');
            hidden.appendChild(createHiddenLi(kpi));
            li.remove();
        }

        function hideFromAvailable(btn) {
            const li = btn.closest('li');
            const kpi = findKpiById(li.dataset.kpiId);
            if (!kpi) { li.remove(); return; }
            const hidden = $('arrangeHiddenList');
            hidden.appendChild(createHiddenLi(kpi));
            li.remove();
        }

        function unhideIndicator(btn) {
            const li = btn.closest('li');
            const kpi = findKpiById(li.dataset.kpiId);
            if (!kpi) { li.remove(); return; }
            const available = $('arrangeAvailableList');
            available.appendChild(createAvailableLi(kpi));
            li.remove();
        }

        function clearAllOrder() {
            const selectedList = $('arrangeSelectedList');
            const availableList = $('arrangeAvailableList');

            const items = qsa('li[data-kpi-id]', selectedList);
            for (const li of items) {
                const kpi = findKpiById(li.dataset.kpiId);
                if (!kpi) continue;
                availableList.appendChild(createAvailableLi(kpi));
            }
            selectedList.innerHTML = '';
        }

        function openArrangeModal() {
            if (!IS_ADMIN) return;
            if (!redList || redList.length === 0) {
                alert('No red KPIs to arrange.');
                return;
            }

            const modalEl = $('arrangeModal');
            arrangeModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);

            const hiddenList = $('arrangeHiddenList');
            const selectedList = $('arrangeSelectedList');
            const availableList = $('arrangeAvailableList');

            hiddenList.innerHTML = '';
            selectedList.innerHTML = '';
            availableList.innerHTML = '';

            const currentOrderIds = deck
                .filter(s => s.type === 'kpi')
                .map(s => Number(s.kpiId));
            const orderedSet = new Set(currentOrderIds);
            const hiddenSet = new Set(
                redList.filter(k => k.isHidden).map(k => Number(k.kpiId))
            );

            // Hidden
            for (const k of redList) {
                if (hiddenSet.has(Number(k.kpiId))) {
                    hiddenList.appendChild(createHiddenLi(k));
                }
            }

            // Selected (slideshow order)
            for (const id of currentOrderIds) {
                const k = findKpiById(id);
                if (k && !hiddenSet.has(Number(k.kpiId))) {
                    selectedList.appendChild(createSelectedLi(k));
                }
            }

            // Available
            for (const k of redList) {
                const numId = Number(k.kpiId);
                if (!hiddenSet.has(numId) && !orderedSet.has(numId)) {
                    availableList.appendChild(createAvailableLi(k));
                }
            }

            arrangeModalInstance.show();
        }

        async function saveArrangeOrder(ev) {
            ev.preventDefault();
            if (!IS_ADMIN) return;

            const selectedList = $('arrangeSelectedList');
            const hiddenList = $('arrangeHiddenList');

            const selectedLis = qsa('li[data-kpi-id]', selectedList);
            const hiddenLis = qsa('li[data-kpi-id]', hiddenList);

            if (!selectedLis.length && !hiddenLis.length) {
                if (!confirm('You have no KPIs in the slideshow or hidden. Continue?')) return;
            }

            const fd = new FormData();
            fd.append('__RequestVerificationToken', anti());

            selectedLis.forEach(li => {
                fd.append('orderedKpiIds', li.dataset.kpiId);
            });

            hiddenLis.forEach(li => {
                fd.append('hiddenKpiIds', li.dataset.kpiId);
            });

            try {
                const res = await fetch('@Url.Action("SaveOrder", "RedBoard")', {
                    method: 'POST',
                    body: fd,
                    headers: { 'Accept': 'text/plain', 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!res.ok) throw 0;
                await res.text();
                if (arrangeModalInstance) arrangeModalInstance.hide();
                await loadRedList();
            } catch {
                alert('Failed to save arrangement.');
            }
        }

        // ---------------------------
        // Boot
        // ---------------------------
        document.addEventListener('DOMContentLoaded', () => loadRedList());
        window.submitAddAction = submitAddAction;
        window.submitMoveDeadline = submitMoveDeadline;
        window.openAddAction = openAddAction;
        window.openMoveDeadline = openMoveDeadline;
        window.showDecisions = showDecisions;
        window.openArrangeModal = openArrangeModal;
        window.saveArrangeOrder = saveArrangeOrder;

        let isGeneralCreate = false;

        document.addEventListener('DOMContentLoaded', () => {
            const btnGeneral = document.getElementById('btnAddGeneralAction');
            if (btnGeneral) {
                if (!IS_ADMIN) { btnGeneral.classList.add('d-none'); return; }
                btnGeneral.addEventListener('click', () => {
                    isGeneralCreate = true;
                    $('af_kpiId').value = '';
                    $('af_owner').value = '';
                    $('af_description').value = '';
                    $('af_due').value = '';
                    $('af_status').value = 'todo';
                    const m = new bootstrap.Modal(document.getElementById('addActionModal'));
                    m.show();
                });
            }
        });
    </script>
}

<div class="container py-4">
    @section PageHeader {
        <div class="page-hero" style="background-image:url('@Url.Content("~/images/pic1.jpg")')">
            <div class="page-hero-content">
                <h1 class="page-title">RedBoard</h1>
            </div>
        </div>
    }
    <div class="with-rails">
        <form id="af" method="post" class="d-none">
            @Html.AntiForgeryToken()
        </form>

        <div id="emptyMsg" class="alert alert-secondary rounded-4 d-none">
            No KPIs are currently marked <strong>Écart (red)</strong>.
        </div>

        <div id="slideWrap" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="me-2">
                    <div class="h4 mb-0 fw-bold" id="kpiHeading">—</div>
                    <div class="text-muted" id="kpiSub" style="white-space:pre-line;">—</div>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted" id="slideCounter">0 / 0</span>
                    <span id="redCountBadge" class="badge rounded-pill text-bg-danger d-none px-3 py-2"
                        title="Red KPIs">0 KPIs need attention</span>
                    <button id="btnFirst" class="btn btn-outline-secondary" type="button" onclick="firstSlide()"
                        title="Go to first slide">⏮</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="prevSlide()">◀</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="nextSlide()">▶</button>
                    <button id="btnLast" class="btn btn-outline-secondary" type="button" onclick="lastSlide()"
                        title="Go to last slide">⏭</button>
                </div>
            </div>

            @if (isAdmin)
            {
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openArrangeModal()">
                        Arrange indicators
                    </button>
                </div>
            }

            <div id="titleSlide" class="text-center py-5 d-none">
                <div class="bg-white border rounded shadow-sm p-5">
                    <div class="display-4 fw-bold mb-3">Priority</div>
                    <div class="display-1 fw-bolder" id="titlePriority"></div>
                    <div class="lead text-muted mt-3">Use the arrows to view KPIs.</div>
                </div>
            </div>

            <div id="kpiSlide">
                <div class="row g-4 mb-4">
                    <div class="col-md-9">
                        <div class="bg-white border rounded shadow-sm p-3 alert-tint" style="height:550px;">
                            <canvas id="rbChart" role="img" aria-label="KPI Chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3 d-flex">
                        <div class="card shadow-sm rounded-3 w-100">
                            <div class="card-body d-flex flex-column justify-content-between h-100">
                                <div>
                                    <h6 class="card-title text-secondary fw-bold mb-3">KPI Details</h6>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>KPI:</strong> <span id="m_title" class="text-dark">—</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>Code:</strong> <span id="m_code" class="text-dark">—</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>Owner:</strong> <span id="m_owner" class="text-dark">—</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>Editor:</strong> <span id="m_editor" class="text-dark">—</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>Frequency:</strong> <span id="m_frequency" class="text-dark">—</span>
                                    </p>
                                    <p class="mb-2" style="font-size: larger;">
                                        <strong>Unit:</strong> <span id="m_unit" class="text-dark">—</span>
                                    </p>
                                </div>
                                <div class="mt-auto">
                                    <div class="mb-4 text-center">
                                        <div class="text-muted">Priority</div>
                                        <div id="m_priority" class="display-6 fw-bold text-dark">—</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-muted mb-1">Status</div>
                                        <span id="m_status" class="status-pill">—</span>
                                    </div>
                                    <div class="text-center mt-3">
                                        <button id="btnAddAction" class="btn btn-primary@(isAdmin ? "" : " d-none")"
                                            type="button" onclick="openAddAction()" disabled>
                                            ➕ Add Action
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="actionsBlock" class="mt-3 d-none">
                <div class="bg-white border rounded-3 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 text-secondary fw-bold">Actions for this KPI</h6>
                    </div>
                    <div id="actionsList"></div>
                </div>
            </div>

            <div id="decisionsWrap" class="mt-4 d-none">
                <div class="bg-white border rounded-3 p-3">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0">Decisions</h5>
                        <button id="btnAddGeneralAction" type="button"
                            class="btn btn-primary btn-sm@(isAdmin ? "" : " d-none")">
                            Add General Action
                        </button>
                    </div>
                    <div id="decisionsBody"></div>
                </div>
            </div>

        </div>

    </div>

    <div class="modal fade" id="addActionModal" tabindex="-1" aria-labelledby="addActionLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-3">
                <div class="modal-header">
                    <h5 class="modal-title" id="addActionLabel">Add Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addActionForm" method="post" onsubmit="submitAddAction(event)">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <input type="hidden" name="KpiId" id="af_kpiId" />
                        <div class="mb-3">
                            <label class="form-label">Owner</label>
                            <select class="form-select" name="Owner" id="af_owner" required>
                                <option value="">— Select —</option>
                                @foreach (var e in employees ??
                                                                Enumerable.Empty<KPIMonitor.ViewModels.EmployeePickDto>())
                                {
                                    var display = e.Label ?? "";
                                    var idx = display.IndexOf('(');
                                    if (idx > 0) { display = display.Substring(0, idx).Trim(); }
                                    <option value="@display">@display</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Assigned At</label>
                            <input type="datetime-local" class="form-control" name="AssignedAt" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Action</label>
                            <textarea class="form-control" name="Description" id="af_description" rows="3"
                                required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="datetime-local" class="form-control" name="DueDate" id="af_due" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="StatusCode" id="af_status">
                                <option value="todo">To Do</option>
                                <option value="inprogress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                        <input type="hidden" name="ExtensionCount" value="0" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Action</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="moveDeadlineModal" tabindex="-1" aria-labelledby="moveDeadlineLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-3">
                <div class="modal-header">
                    <h5 class="modal-title" id="moveDeadlineLabel">Move Deadline</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="moveDeadlineForm" method="post" onsubmit="submitMoveDeadline(event)">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <input type="hidden" name="actionId" id="md_actionId" />
                        <div class="mb-3">
                            <label class="form-label">New Due Date</label>
                            <input type="datetime-local" class="form-control" name="newDueDate" id="md_due" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason (optional)</label>
                            <textarea class="form-control" name="reason" id="md_reason" rows="2"></textarea>
                        </div>
                        <div class="text-muted small">Max 3 extensions enforced.</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Move</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Arrange Indicators Modal -->
    <div class="modal fade" id="arrangeModal" tabindex="-1" aria-labelledby="arrangeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable arrange-modal-dialog">
            <div class="modal-content rounded-3">
                <div class="modal-header">
                    <h5 class="modal-title" id="arrangeModalLabel">Arrange Red Indicators</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="arrangeForm" onsubmit="saveArrangeOrder(event)">
                    @Html.AntiForgeryToken()
                    <div class="modal-body">
                        <p class="text-muted small">
                            Use <strong>Hide</strong> to exclude indicators from the slideshow completely.
                            Use <strong>Clear order</strong> to move everything from the slideshow back to Available.
                        </p>
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Hidden (won’t appear)</h6>
                                <ul id="arrangeHiddenList" class="list-group small"
                                    style="max-height: 360px; overflow-y: auto;"></ul>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">Available red KPIs</h6>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                        onclick="clearAllOrder()">
                                        Clear order
                                    </button>
                                </div>
                                <ul id="arrangeAvailableList" class="list-group small"
                                    style="max-height: 360px; overflow-y: auto;"></ul>
                            </div>
                            <div class="col-md-4">
                                <h6>Slideshow order</h6>
                                <ul id="arrangeSelectedList" class="list-group small"
                                    style="max-height: 360px; overflow-y: auto;"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <span class="text-muted small me-auto">Changes affect only the RedBoard slideshow.</span>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save arrangement</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>